***************************************************************
;*           DIGITAL RESEARCH MACRO ASSEMBLER VER 2.0
;*
;*  RECONSTRUCTED FROM MAC.COM MEMORY IMAGE AND ASM SOURCE CODE
;*          ON APRIL 25, 2020 BY PATRICK A. LINSTRUTH
;*
;*                    PATRICK@DELTECENT.COM
;*
;***************************************************************

;	COPYRIGHT (C) 1977,1978,1979
;	DIGITAL RESEARCH
;	BOX 579, PACIFIC GROVE
;	CALIFORNIA, 93950

	TITLE	'MAC COMMON DATA AREA'
;
;	COMMON DATA FOR CP/M MACRO ASSEMBLER MODULE
BOOT	EQU	0000H	;REBOOT LOCATION
FBASE	EQU	0006H	;
FCB	EQU     5CH     ;FILE CONTROL BLOCK ADDRESS
BUFF	EQU	80H	;IO BUFFER AND COMMAND LINE STORAGE
BSIZE	EQU	128	;IO BUFFER SIZE
FNM	EQU     1       ;FCB POSITION OF FILE NAME
FNML	EQU     8       ;FCB FILE NAME LENGTH

;	DOS ENTRY POINTS
BDOS	EQU	0005H	;BDOS ENTRY POINT
READC	EQU	1	;READ CONSOLE DEVICE
WRITC	EQU	2	;WRITE CONSOLE DEVICE
WRITP	EQU	5	;WRITE PRINTER
REDYC	EQU	11	;CONSOLE CHARACTER READY
SELECT	EQU	14	;SELECT DISK SPECIFIED BY REGISTER E
OPENF	EQU	15	;OPEN FILE
CLOSF	EQU	16	;CLOSE FILE
DELEF	EQU	19	;DELETE FILE
READF	EQU	20	;READ FILE
WRITF	EQU	21	;WRITE FILE
MAKEF	EQU	22	;MAKE A FILE
CSEL	EQU	25	;RETURN CURRENTLY SELECTED DISK
SETDM	EQU	26	;SET DMA ADDRESS

;	ASCII CHARACTERS
TAB	EQU	009H	;TAB
CR	EQU	00DH	;CARRIAGE RETURN
LF	EQU	00AH	;LINE FEED
FF	EQU	00CH	;FORM FEED
EOF	EQU	01AH	;END OF FILE

;	BOOLEANS
FALSE	EQU	0
TRUE	EQU	NOT FALSE

;
;	FILE AND BUFFERING PARAMETERS
;
NSB	EQU	8	;NUMBER OF SOURCE FILE BUFFERS
NPB	EQU	6	;NUMBER OF PRINT FILE BUFFERS
NHB	EQU	6	;NUMBER OF HEX FILE BUFFERS

SSIZE	EQU	NSB*128
PSIZE	EQU	NPB*128
HSIZE	EQU	NHB*128

ENDAS0M	EQU	($ AND 0FF00H)+100H

;***************************************************************

	TITLE	'ASM MAIN MODULE'
;	CP/M RESIDENT ASSEMBLER MAIN PROGRAM

	ORG	00100H

;	TOKEN TYPES
IDEN	EQU	1	;IDENTIFIER
NUMB	EQU	2	;NUMBER
STRNG	EQU	3	;STRING
SPECL	EQU	4	;SPECIAL CHARACTER
TOKEN5	EQU	5	;UNKNOWN
COMM	EQU	6	;COMMENT
;
PLABT	EQU	0001B	;PROGRAM LABEL
DLABT	EQU	0010B	;DATA LABEL
EQUT	EQU	0100B	;EQUATE
SETT	EQU	0101B	;SET
MACT	EQU	0110B	;MACRO
UNDT	EQU	0111B	;UNKNOWN
;
EXTT	EQU	1000B	;EXTERNAL
REFT	EQU	1011B	;REFER
GLBT	EQU	1100B	;GLOBAL
;
BINV	EQU	2
OCTV	EQU	8
DECV	EQU	10
HEXV	EQU	16

	JMP	START

	DB	' COPYRIGHT (C) 1977 DIGITAL RESEARCH '

START:
	LXI	SP,ENDMAC
;
;	MAIN STATEMENT PROCESSING LOOP
	XRA	A
	STA	PASS	;SET TO PASS 0 INITIALLY
	STA	L305A
	CALL	INITIO	;INITIALIZE IO MODULE
	CALL	INISYE	;INITIALIZE THE SYMBOL TABLE
	LXI	H,0
	SHLD	L11D6H	;SET TO ZERO
RESTART:
	CALL	S1C4BH
	XRA	A
	STA	L2EA3H
	MVI	A,0
	STA	L2EA4H
	LHLD	SYMAX
	SHLD	L2F24H
	CALL	INITSE
	CALL	S2583H
	LXI	H,0
	SHLD	SYLAB	;ASSUME NO STARTING LABEL
	SHLD	L11DEH
	LDA	PARMR
L0162H:
	ORA	A
	JZ	INIPC	;NO 'R' PARAMETER
	LXI	H,0100H	;SET PC TO 0100H
;
INIPC:	;INITIALIZE PC
	SHLD	FPC
	SHLD	ASPC
	SHLD	EPC	;END PC
	XRA	A
	STA	IFCNT	;CLEAR IF NEST COUNT
;
SCNEXT:	;SCAN NEXT INPUT ITEM
	CALL	SCANE
;
SCN0:
	LDA	TOKEN
	CPI	NUMB	;SKIP LEADING NUMBERS FROM LINE EDITORS
	JZ	SCNEXT
	CPI	SPECL	;MAY BE PROCESSOR TECH'S COMMENT
	JNZ	SCN1
;	SPECIAL CHARACTER, CHECK FOR $,-,+,*
	LDA	ACCUM
	CPI	'$'
	JNZ	CHEND
	CALL	SETLA
	JNZ	STERR
	LDA	NEXTC
	MVI	B,0
	CPI	'-'
	JZ	L01ACH
	MVI	B,3
	CPI	'+'
	JZ	L01ACH
	MVI	B,7
	CPI	'*'
	JNZ	STERR	;ERROR IF NOT *
;
L01ACH:
	PUSH	B
	CALL	SCANE
	POP	B
	LDA	NEXTC
	LXI	H,PARMM
	CPI	'M'
	JZ	L01C4H
	LXI	H,L3066
	CPI	'P'
	JNZ	STERR
;
L01C4H:
	MOV	M,B
	CALL	SCANE
	JMP	POEND
SCN1:	;NOT NUMBER OR SPECIAL CHARACTER, CHECK FOR IDENTIFIER
	CPI	IDEN
	JNZ	STERR	;ERROR IF NOT

	CALL	BGETE
	JZ	CHKPT
	CALL	LOOKUPE
	CALL	FOUNDE
	JNZ	L01ECH
	CALL	ENTERE
	LDA	PASS
	ORA	A
	CNZ	ERRP
	JMP	L03E9H
;
L01ECH:
	CALL	GETTYE
	CPI	MACT
	JNZ	L03E9H
	LXI	H,0
	SHLD	L11E0H
	LDA	PASS
	ORA	A
	JZ	L020FH
;
L0201H:
	CALL	GETVALE
	XCHG
	LHLD	SYADR
	MOV	A,L
	SUB	E
	MOV	A,H
	SBB	D
	JC	L023CH
;
L020FH:
	CALL	S0272H
	CALL	S160CH
	CALL	S02AAH
	JNZ	L02C1H
	LHLD	SYLAB
	MOV	A,H
	ORA	L
	CNZ	ERRS
	LDA	PASS
	ORA	A
	JNZ	L025FH
	CALL	S0291H
	CALL	S1C48H
	CALL	ENTERE
	LHLD	SYADR
	SHLD	SYLAB
	JMP	SMACRO
;
L023CH:
	LHLD	SYADR
	SHLD	L11E0H
	CALL	S1C45H
	CALL	FOUNDE
	JZ	L0256H
	CALL	GETTYE
	CPI	006H
	JNZ	L02BBH
	JMP	L0201H
L0256H:
	CALL	S160CH
	CALL	S02AAH
	JNZ	L02BBH
L025FH:
	LHLD	L11E0H
	XCHG	
	LHLD	L11D8H
	CALL	COMPDH
	JNZ	L02BBH
	SHLD	SYLAB
	JMP	SMACRO
S0272H:
	LHLD	SYTOP
	PUSH	H
	SHLD	L3058	;SYMAC = SYTOP
	LXI	H,ACCLEN
	MOV	C,M
	MOV	B,C
L027EH:
	INX	H
	MOV	A,M
	PUSH	B
	PUSH	H
	CALL	S1C27H
	POP	H
	POP	B
	DCR	C
	JNZ	L027EH
	POP	H
	MOV	M,B
	SHLD	SYTOP
	RET
S0291H:
	LHLD	SYTOP
	MOV	C,M
	SHLD	L3058
	LXI	H,ACCLEN
	MOV	M,C
L029CH:
	INX	H
	PUSH	B
	PUSH	H
	CALL	S1C2AH
	POP	H
	POP	B
	MOV	M,A
	DCR	C
	JNZ	L029CH
	RET
S02AAH:
	LDA	TOKEN
	CPI	TOKEN5	;INVALID TOKEN?
	RNZ		;NO
	CALL	BGETE
	RNZ	
	CPI	EOF
	RNZ	
	MOV	A,B
	CPI	TAB
	RET
L02BBH:
	CALL	ERRP
	JMP	CHEND
L02C1H:
	LHLD	SYADR
	PUSH	H
	CALL	FILAB
	LHLD	ASPC
	LDA	PARMM
	ORA	A
	CZ	PADDR
	POP	H
	SHLD	SYADR
	CALL	S1C1EH
	STA	L11C2H
	LHLD	SYMAX
	PUSH	H
	ORA	A
	JZ	L0372H
	JMP	L0300H
;
SCCRT:	;TEST FOR SEMI-COLON OR CR
	CPI	';'
	RZ
	CPI	CR
	RZ
;
LFEET:	;TEST FOR LF, EOF, OR EXCLAMATION
	CPI	LF
	RZ
	CPI	EOF
	RZ
	CPI	'!'
	RET
;
L02F6H:
	LDA	L11C2H
	ORA	A
	JZ	L0372H
	CALL	S160CH
;
L0300H:
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0346H
	LDA	ACCUM
	CALL	SCCRT
	JZ	L0365H
	CPI	'%'	;EVALUATE 16BIT VALUE
	JNZ	L033BH
	CALL	EXP16
	SHLD	NEVAL
	MVI	A,TRUE
	STA	L11DBH
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0362H
	LDA	ACCUM
	PUSH	PSW
	XRA	A
	STA	ACCLEN	;RESET ACCUMULATOR
	CALL	L0D0EH
	CALL	S03DBH
	POP	PSW
	JMP	L0357H
;
L033BH:
	CPI	','
;
L033DH:
	JNZ	L0346H
	CALL	S03D7H
	JMP	L02F6H
;
L0346H:
	CALL	S03DBH
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0362H
	LDA	ACCUM
;
L0357H:
	CALL	SCCRT
	JZ	L0365H
	CPI	','
	JZ	L02F6H
;
L0362H:
	CALL	ERRS
;
L0365H:
	LDA	L11C2H
	ORA	A
	JZ	L0372H
	CALL	S03D7H
	JMP	L0365H
;
L0372H:
	LHLD	L3058
	INX	H
	PUSH	H
;
L0377H:
	LXI	H,NEXTC
	MOV	A,M
	CALL	LFEET	;TEST FOR LF, EOF, OR EXCLAMATION
	JZ	L0387H	;YES
	CALL	SCANE
	JMP	L0377H
;
L0387H:
	XRA	A
	MOV	M,A
	STA	L2F14H
	CALL	S03ACH
	LDA	IFCNT
	STA	L2F54H
	CALL	S1C2DH
	POP	H
	SHLD	L2EF4H
	POP	H
	SHLD	L2F24H
	XRA	A
	STA	L2F14H
	MVI	A,1
	STA	L2EA4H
	JMP	SCNEXT
S03ACH:
	LDA	L2EA3H
	ORA	A
	JZ	L03B8H
	LXI	H,CBUFF+5
	MVI	M,'+'
;
L03B8H:
	CALL	S2595H
	MVI	A,16	;START OF SOURCE LINE
	STA	CBP
	RET	
;
L03C1H:
	LDA	L2EA3H
	ORA	A
	JZ	ERRB
	LDA	L2EA4H
	CPI	3
	RNC 
	CPI	1
	RZ
	CALL	S1C30H
	JMP	L03C1H
S03D7H:
	XRA	A
	STA	ACCLEN
S03DBH:
	CALL	S1C39H
	CALL	S1C24H
	CALL	S1C3CH
	LXI	H,L11C2H
	DCR	M
	RET
;
L03E9H:
	LHLD	SYLAB
	MOV	A,L
	ORA	H
	CNZ	ERRL
	LHLD	SYADR
	SHLD	SYLAB
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	SCN0
	LDA	ACCUM
	CPI	':'
	JNZ	SCN0
	JMP	SCNEXT
;
;       BINARY SEARCH FOUND SYMBOL, CHECK FOR PSEUDO OR REAL OP
CHKPT:
	CPI	PT
	JNZ	CHKOT
;
;       PSEUDO OPCODE FOUND, BRANCH TO CASES
	MOV	E,B
	MVI	D,0
	DCX	D
	LXI	H,PTTAB
	DAD	D
	DAD	D
	MOV	E,M
	INX	H
	MOV	H,M
	MOV	L,E
	PCHL

PTTAB:	;PSEUDO OPCODE JUMP TABLE
	DW	SDB
	DW	SDS
	DW	SDW
	DW	SEND
	DW	SENDIF
	DW	SENDM
	DW	SEQU
	DW	SIF
	DW	SMACRO
	DW	SORG	
	DW	SSET
	DW	STITLE
	DW	SELSE
	DW	SIRP
	DW	SIRPC
	DW	SREPT
	DW	SASEG
	DW	SCSEG
	DW	SDSEG
	DW	SNAME
	DW	SPAGE
	DW	SEXITM
	DW	SEXTRN
	DW	SLOCAL
	DW	SINPAGE
	DW	SMACLIB
	DW	SPUBLIC
	DW	SSTKLN
;
SDB:
	CALL	FILAB	;SET LABEL FOR THIS LINE TO ASPC
SDB0:
	CALL	SCANE	;PAST DB TO NEXT ITEM
	LDA	TOKEN	;LOOK FOR LONG STRING
	CPI	STRNG
	JNZ	SDBC	;SKIP IF NOT STRING
	LDA	ACCLEN
	DCR	A	;LENGTH 1 STRING?
	JZ	SDBC
;	LENGTH 0,2 STRING
	MOV	B,A
	INR	B
	INR	B	;BECOMES 1,3,... FOR 0,2,... LENGTHS
	LXI	H,ACCUM	;ADDRESS CHARACTERS IN STRING
SDB1:	DCR	B	;COUNT DOWN TO ZERO
	JZ	SDB2	;SCAN DELIMETER AT END OF STRING
	PUSH	B	;SAVE COUNT
	MOV	B,M	;GET CHARACTER
	INX	H	;H,L TO NEXT CHARACTER
	PUSH	H	;SAVE ACCUM POINTER
	CALL	FILHB	;SEND TO HEX FILE
	POP	H
	POP	B
	JMP	SDB1
SDB2:
	CALL	SCANE	;TO THE DELIMETER
	JMP	SDB3
;
;	NOT A LONG STRING
SDBC:	CALL	OPANDE	;COMPUTER OPERAND
	LHLD	EVALUE	;VALUE TO H,L
	CALL	HL2A
	MOV	B,L	;SAVE TO HEX FILE
	CALL	FILHB
SDB3:	;END OF ITEM - UPDATE ASPC
	CALL	SETAS	;SET ASPC TO FPC
	CALL	DELIM
	CPI	','
	JZ	SDB0	;FOR ANOTHER ITEM
	JMP	CHEND	;CHECK END OF LINE SYNTAX
;
SDS:
	CALL	FILAB	;HANDLE LABEL IF IT OCCURRED
	CALL	PADD	;PRINT ADDRESS
	CALL	EXP16	;SCAN AND GET 16BIT OPERAND
	XCHG		;TO D,E
	LHLD	ASPC	;CURRENT PSEUDO PC
	DAD	D	;+ EXPRESSION
	SHLD	ASPC	;SAVE ASPC
	SHLD	FPC	;NEXT TO FILL
	JMP	CHEND

SDW:
	CALL	FILAB	;HANDLE OPTIONAL LABEL
SDW0:
	CALL	EXP16	;GET 16BIT OPERAND
	PUSH	H	;SAVE A COPY
	MOV	B,L	;LOW BYTE FIRST
	CALL	FILHB	;SEND LOW BYTE
	POP	H	;RECLAIM A COPY
	MOV	B,H	;HIGH BYTE NEXT
	CALL	FILHB	;SEND HIGH BYTE
	CALL	SETAS	;SET ASPC=FPC
	CALL	DELIM	;CHECK DELIMETER SYNTAX
	CPI	','
	JZ	SDW0	;GET MORE DATA
	JMP	CHEND
;
SEND:
	CALL	FILAB	;HANDLE OPTIONAL LABEL
	CALL	PADD	;WRITE LAST LOC
	LDA	CBUFF
	CPI	' '
	JNZ	CHEND
	CALL	EXP16	;GET EXPRESSION OF IT'S THERE
	LDA	CBUFF
	CPI	' '
	JNZ	SEND0
	SHLD	EPC	;EXPRESSION FOUND, STORE IT FOR LATER
SEND0:	MVI	A,' '
	STA	CBUFF	;CLEAR ERROR IF IT OCCURRED
	LDA	IFCNT
	ORA	A
	CNZ	ERRB
	CALL	SCANE	;CLEAR CR
	LDA	TOKEN
	CPI	SPECL
	JNZ	STERR
	LDA	ACCUM
	CPI	LF
	JNZ	STERR
	JMP	ENDAS	;END OF ASSEMBLER

SENDIF:
	CALL	FILAB
	CALL	S09B2H
	JMP	POEND

SENDM:
	PUSH	B
	CALL	FILAB
	CALL	L03C1H
	LXI	H,CBUFF+5	;AFTER PC
	MVI	M,'+'	;MARK STATEMENT AS MACRO
	LDA	L2EA4H
	CPI	3
	JNC	L053BH
	POP	B
	CALL	S1C3FH
	JMP	L0616H
;
L053BH:
	LHLD	L2F24H
	PUSH	H
	LHLD	L2EB4H	;SOME 32-BYTE BUFFER
	SHLD	L2F24H
	CALL	S1C3FH
	POP	H
	SHLD	L2F24H
	POP	PSW
	CPI	006H
	JNZ	L0616H
;
L0552H:
	LDA	L2EA4H
	CPI	6
	JNZ	L056CH
	LHLD	L2EB4H	;SOME 32-BYTE BUFFER
	MOV	E,M
	INX	H
	MOV	D,M
	MOV	A,E
	ORA	D
	JZ	L0616H	;NULL VALUE?
	DCX	D
	MOV	M,D
	DCX	H
	MOV	M,E
	JMP	L0635H
;
L056CH:
	LHLD	L2EB4H	;SOME 32-BYTE BUFFER
	MOV	E,M
	INX	H
	MOV	D,M
	LDAX	D
	CPI	CR
	JZ	L0616H
	ORA	A
	JZ	L0593H
	LDA	L2EA4H
	CPI	3
	JNZ	L05A0H
	LDAX	D
	INX	D
	MOV	M,D
	DCX	H
	MOV	M,E
	LXI	H,ACCLEN
	MVI	M,001H
	INX	H
	MOV	M,A
	JMP	L059AH
;
L0593H:
	MVI	A,CR
	STAX	D
	XRA	A
	STA	ACCLEN
;
L059AH:
	CALL	S1C39H
	JMP	L0606H
;
L05A0H:
	LXI	H,L2F65H
	MOV	A,M
	PUSH	PSW
	MVI	M,000H
	LXI	H,NEXTC
	MOV	A,M
	PUSH	PSW
	MVI	M,000H
	XCHG
	SHLD	L2EF4H
	MOV	A,M
	SUI	02CH
	JNZ	L05C5H
	INX	H
	PUSH	H
	LXI	H,ACCLEN
	MOV	M,A
	CALL	S1C39H
	POP	H
	JMP	L05F0H
;
L05C5H:
	PUSH	H
	CALL	S160CH
	POP	D
	CALL	S11E4H
	JMP	L05D0H
;
L05D0H:
	CALL	S1C39H
	LHLD	L2EF4H
	MOV	A,M
	ORA	A
	JNZ	L05E0H
	MVI	M,CR
	JMP	L05F7H
;
L05E0H:
	LHLD	L11E2H
	PUSH	H
	CALL	SCANE
	LDA	ACCUM
	CPI	','
	CNZ	ERRS
	POP	H
;
L05F0H:
	CALL	S11EEH
	XRA	A
	STA	L2F66H
;
L05F7H:
	XCHG
	LHLD	L2EB4H	;SOME 32-BYTE BUFFER
	MOV	M,E
	INX	H
	MOV	M,D
	POP	PSW
	STA	NEXTC
	POP	PSW
	STA	L2F65H
;
L0606H:
	LHLD	L2EB4H	;SOME 32-BYTE BUFFER
	INX	H
	SHLD	L3058
	CALL	S1C24H
	CALL	S1C3CH
	JMP	L0635H
;
L0616H:
	CALL	S03ACH
	LHLD	L2F24H
	SHLD	SYMAX	;SAVE IN SYMAX
	CALL	S1C30H
	LDA	L2F54H
	STA	IFCNT
	LDA	L2F14H
	STA	NEXTC
	ORA	A
	CNZ	S1609H
	JMP	SCNEXT
;
L0635H:
	MVI	A,16	;START OF SOURCE LINE
	STA	CBP
	LHLD	L2ED4H
	SHLD	L2EF4H
	XRA	A
	STA	NEXTC
	JMP	SCNEXT
;
PASPC:	;GET 16BIT OPERAND, PRINT IT, UDPATE CBUFF+6
	PUSH	PSW
	LHLD	ASPC	;HOLD TEMP ASPC
	PUSH	H	;IN STACK
	CALL	EXP16	;GET 16BIT OPERAND
	SHLD	ASPC	;VALUE OF EXPRESSION
	CALL	PADDR	;COMPUTED VALUE
	POP	H	;REAL ASPC
	SHLD	ASPC
	POP	PSW
	LXI	H,CBUFF+6	;SPACE AFTER VALUE
	MOV	M,A
	RET
;
;	LABEL EQU EXPRESSION
SEQU:
	CALL	SETLA
	JZ	STERR	;MUST BE A LABEL
	MVI	A,'='	;EQU
	CALL	PASPC	;VALUE IN EVALUE
	LHLD	ASPC	;HOLD TEMP ASPC
	PUSH	H	;IN STACK
	LHLD	EVALUE
	SHLD	ASPC
	CALL	FILAB
	POP	H	;REAL ASPC
	SHLD	ASPC
	JMP	CHEND
;
;	IF EXPRESSION
SIF:
	CALL	FILAB	;IN CASE OF LABEL
	CALL	EXP16	;GET 'IF' EXPRESSION, VALUE IN H,L
	LDA	CBUFF
	CPI	' '
	JNZ	L08C1H	;ERROR?
	MOV	A,L
	RAR
	MVI	A,1	;IF
	JNC	L08C1H
	CALL	S099EH
	JMP	CHEND
;
;	MACNAME MACRO D-1,D-2,. . .,D-N
SMACRO:
	CALL	SETLA
	JNZ	SMAC0	;MACRO MUST HAVE A LABEL
	CALL	ERRL
	JMP	CHEND
SMAC0:
	LDA	PASS
	ORA	A	;
	JZ	SMAC2	;JMP IF PASS 0
;	PASS 1
	LHLD	SYADR
	XCHG	
	LHLD	L11D8H
	CALL	COMPDH
	JZ	SMAC1
	CALL	ERRP
	JMP	SMAC3
SMAC1:
	CALL	GETVALE
	SHLD	L11D8H
	JMP	SMAC3
SMAC2:
	MVI	A,MACT	;MACRO TYPE
	CALL	SETTYE
SMAC3:
	XRA	A
	STA	L11DAH
	LDA	PASS
	ORA	A
	CZ	S1C1BH
SMAC4:
	CALL	SCANE
	LDA	TOKEN
	CPI	IDEN
	JNZ	SMAC5
	LDA	PASS
	ORA	A
	CZ	S1C21H
	LXI	H,L11DAH
	INR	M
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	SMAC5
	LDA	ACCUM
	CPI	','
	JZ	SMAC4
SMAC5:
	MVI	A,1
	CALL	S0722H
	JZ	L0E34H
	LDA	PASS
	ORA	A
	LDA	L11DAH
	CZ	S1C1BH
	JMP	POEND
S0716H:
	CPI	009H
	RZ	
	CPI	010H
	RZ	
	CPI	00EH
	RZ	
	CPI	00FH
	RET	
;
S0722H:
	STA	0305CH
;
L0725H:
	LDA	TOKEN
	CPI	SPECL
	JNZ	L073DH
	LDA	ACCUM
	CPI	CR
	JZ	L0746H
	CPI	'!'
	JZ	L0746H
	CPI	EOF
	RZ	
;
L073DH:
	CALL	ERRS
	CALL	SCANE
	JMP	L0725H
;
L0746H:
	LHLD	L3058
	SHLD	L3060
	MVI	A,1
	STA	L305A
	CALL	SCANE
;
L0754H:
	LHLD	L3058
	SHLD	L11E0H
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	L076BH
	LDA	ACCUM
	CPI	EOF
	RZ	
;
L076BH:
	CPI	IDEN
	JNZ	L0754H
	CALL	BGETE
	JNZ	L0754H
	PUSH	PSW
	LDA	0305CH
	CPI	1
	JNZ	L07A6H
	LDA	PASS
	ORA	A
	JNZ	L07A6H
	LDA	ACCLEN
	DCR	A
	JZ	L07A6H
	DCR	C
	JZ	L07A6H
	PUSH	B
	LHLD	L11E0H
	SHLD	L3058
	CALL	S2109H
	CALL	S1C27H
	LDA	NEXTC
	ORA	A
	CNZ	S1C27H
	POP	B
;
L07A6H:
	POP	PSW
	CPI	EOF
	JNZ	L0754H
	MOV	A,B
	CALL	S0716H
	JNZ	L07BBH
	LXI	H,L305A
	INR	M
	RZ	
	JMP	L0754H
;
L07BBH:
	CPI	006H
	JNZ	L0754H
	LXI	H,L305A
	DCR	M
	JNZ	L0754H
	LDA	0305CH
	CPI	1
	JNZ	L07F6H
	LXI	H,0
	SHLD	SYLAB
	LDA	MLFLG
	ORA	A
	JZ	L07E5H
	LXI	H,0
	CALL	SETVALE
	JMP	L07F1H
;
L07E5H:
	LHLD	L11D6H
	CALL	SETVALE
	LHLD	SYADR
	SHLD	L11D6H	;11D6 = SYADR
;
L07F1H:
	LDA	PASS
	ORA	A
	RNZ	
;
L07F6H:
	LHLD	L3058
	MOV	A,M
	CPI	CR
	CNZ	ERRS
	LHLD	L3058
	MVI	M,CR
	XRA	A
	CALL	S1C27H
	XRA	A
	INR	A
	RET	
;
;	LABEL ORG EXPRESSION
SORG:
	CALL	EXP16
	LDA	CBUFF
	CPI	' '
	JNZ	CHEND	;SKIP OR IF ERROR
	LDA	PARMR	;'R' PARAMETER?
	ORA	A
	JZ	SETPC
	LXI	D,0100H	;ADD 0100H TO ORG
	DAD	D
;
SETPC:
	SHLD	ASPC	;CHANGE PC
	SHLD	FPC	;CHANGE NEXT TO FILL
	CALL	FILAB	;IN CASE OF LABEL
	CALL	PADD
	JMP	CHEND
;
; 	LABEL SET EXPRESSION
SSET:
	CALL	SETLA
	JZ	STERR	;MUST BE LABELED
	CALL	GETTYE
	ORA	A	;IS TYPE UNDEFINED?
	JZ	SSET0	;SAVE SET VALUE
	CPI	SETT	;ERROR IF NOT SET TYPE
	CNZ	ERRL	;LABEL ERROR
;
SSET0:
	MVI	A,SETT
	CALL	SETTYE
	MVI	A,'#'	;SET
	CALL	PASPC
	CALL	SETLA
	LHLD	EVALUE
	CALL	SETVALE
	LXI	H,0
	SHLD	SYLAB
	JMP	CHEND
;
;	TITLE string-constant
STITLE:	
	CALL	FILAB
	CALL	SCANE
	LDA	TOKEN
	CPI	STRNG
	JNZ	STERR
	LDA	L305A
	ORA	A
	JNZ	STERR
	LXI	H,ACCLEN
	MOV	C,M
	XCHG
	LHLD	SYTOP
	LDA	PASS
	ORA	A
	JNZ	L089FH
	SHLD	L3062
	DCX	H
	SHLD	L3058
;
L0889H:
	MOV	A,C
	ORA	A
	JZ	L089BH
	INX	D
	LDAX	D
	DCR	C
	PUSH	D
	PUSH	B
	CALL	S1C27H
	POP	B
	POP	D
	JMP	L0889H
;
L089BH:
	XRA	A
	CALL	S1C27H
;
L089FH:
	JMP	POEND
;
;	ELSE
SELSE:
	CALL	FILAB
	CALL	S09B2H
	CPI	1
	MVI	A,2
	JZ	L08C1H
	CALL	ERRB
	JMP	POEND

S08B5H:
	CPI	009H
	RZ
	CPI	00EH
	RZ
	CPI	00FH
	RZ
	CPI	010H
	RET	
;
L08C1H:
	STA	L11CAH
	XRA	A
	STA	L11CBH
	STA	L11CCH
;
L08CBH:
	LDA	TOKEN
	CPI	SPECL
	JNZ	L08F1H
	LDA	ACCUM
	CPI	CR
	JNZ	L08E1H
	CALL	SCANE
	JMP	L08F7H
;
L08E1H:
	CPI	'!'
	JZ	L08F7H
	CPI	EOF
	JNZ	L08F1H
	CALL	ERRB
	JMP	ENDAS
;
L08F1H:
	CALL	SCANE
	JMP	L08CBH
;
L08F7H:
	CALL	SCANE
	LDA	TOKEN
	CPI	NUMB
	CZ	SCANE
	LDA	TOKEN
	CPI	1
	JNZ	L08CBH
	CALL	BGETE
	JZ	L0934H
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0926H
	LDA	ACCUM
	CPI	03AH
	JNZ	L08CBH
	CALL	SCANE
;
L0926H:
	LDA	TOKEN
	CPI	IDEN
	JNZ	L08CBH
	CALL	BGETE
	JNZ	L08CBH
;
L0934H:
	CPI	EOF
	JNZ	L08CBH
	MOV	A,B
	CPI	008H
	JNZ	L0949H
	LXI	H,L11CBH
	INR	M
	CZ	ERRO
	JMP	L08CBH
;
L0949H:
	CPI	CR
	JNZ	L0965H
	LDA	L11CBH
	ORA	A
	JNZ	L08CBH
	LDA	L11CAH
	CPI	2	;ELSE
	CZ	ERRB
	MVI	A,2	;ELSE
	CALL	S099EH
	JMP	POEND
;
L0965H:
	CPI	005H
	JNZ	L097DH
	LXI	H,L11CBH
	MOV	A,M
	DCR	M
	ORA	A
	JNZ	L08CBH
	LDA	L11CCH
	ORA	A
	CNZ	ERRB
	JMP	POEND
;
L097DH:
	CALL	S08B5H
	JNZ	L098DH
	LXI	H,L11CCH
	INR	M
	CZ	ERRO
	JMP	L08CBH
;
L098DH:
	CPI	6
	JNZ	L08CBH
	LXI	H,L11CCH
	MOV	A,M
	DCR	M
	ORA	A
	JNZ	L08CBH
	JMP	SENDM
;
S099EH:
	MOV	B,A	;1=IF 2=ELSE
	LXI	H,IFCNT
	MOV	A,M
	CPI	8	;NESTING UP TO 8 DEEP
	JNC	ERRO	;ERROR
	INR	M	;IFCNT=INCNT+1
	MOV	E,A
	MVI	D,0
	LXI	H,IFSTK
	DAD	D	;H,L STACK INDEX
	MOV	M,B
	RET	
;
S09B2H:
	LXI	H,IFCNT
	MOV	A,M
	ORA	A
	JZ	ERRB	;BALANCED 'IF' ERROR
	DCR	M	;DECREMENT IF NEST COUNT
	MOV	E,M
	MVI	D,0
	LXI	H,IFSTK
	DAD	D
	MOV	A,M
	RET	
;
;	LABEL: IRP IDENTIFIER,<CL-1,CL-2,. . .,CL-N>
SIRP:
	MVI	A,5
	JMP	L09CBH
;
;	LABEL: IRPC IDENTIFIER,CHARACTER-LIST
SIRPC:
	MVI	A,3
;
L09CBH:
	STA	0305CH
	CALL	FILAB
	CALL	SCANE
	LDA	TOKEN
	CPI	IDEN
	JNZ	L0A4EH
	LHLD	SYTOP
	SHLD	L11C5H
	DCX	H
	SHLD	L3058
	LDA	ACCLEN
	CPI	010H
	JC	L09F0H
	MVI	A,010H
;
L09F0H:
	ADI	003H
	CALL	S1C27H
	XRA	A
	CALL	S1C27H
	CALL	S1C21H
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0A4EH
	LDA	ACCUM
	CPI	','
	JNZ	L0A4EH
	CALL	S160CH
	LDA	ACCLEN
	ORA	A
	JNZ	L0A1FH
	CALL	SCANE
	JMP	L0A3EH
;
L0A1FH:
	CALL	CHKEND
	JZ	L0A3EH
	LXI	H,ACCLEN
	MOV	C,M
;
L0A29H:
	INX	H
	MOV	A,M
	PUSH	B
	PUSH	H
	CALL	S1C27H
	POP	H
	POP	B
	DCR	C
	JNZ	L0A29H
	MVI	A,CR
	CALL	S1C27H
	CALL	SCANE
;
L0A3EH:
	XRA	A
	CALL	S1C27H
	LHLD	SYTOP
	SHLD	SYADR
	LDA	0305CH
	JMP	L0A78H
;
L0A4EH:
	CALL	ERRS
	LDA	0305CH
	CALL	S0722H
	JMP	POEND

SREPT:
	CALL	EXP16
	PUSH	H
	MOV	A,L
	LHLD	SYTOP
	SHLD	L11C5H
	DCX	H
	SHLD	L3058
	CALL	S1C27H
	POP	PSW
	CALL	S1C27H
	LHLD	SYTOP
	SHLD	SYADR
	MVI	A,6
;
L0A78H:
	CALL	S0722H
	JZ	L0E34H
	CALL	S03ACH
	CALL	SCANE
	LDA	IFCNT
	STA	L2F54H
	LDA	NEXTC
	CPI	LF
	JNZ	L0A93H
	XRA	A
;
L0A93H:
	STA	L2F14H
	CALL	S1C2DH
	LHLD	SYMAX
	SHLD	L2F24H
;
L0A9FH:
	LHLD	L3058
	XCHG
	LXI	H,L11C5H
	MOV	A,E
	SUB	M
	INX	H
	MOV	A,D
	SBB	M
	XCHG
	JC	L0ABFH
	MOV	A,M
	DCX	H
	SHLD	L3058
	LHLD	SYMAX
	DCX	H
	SHLD	SYMAX
	MOV	M,A
	JMP	L0A9FH
;
L0ABFH:
	INX	H
	SHLD	SYTOP
	LHLD	SYMAX
	SHLD	L2EB4H
	NOP
	LDA	0305CH
	CPI	6
	JZ	L0ADDH
	MOV	C,M
	MVI	B,000H
	MOV	E,L
	MOV	D,H
	DAD	B
	XCHG
	MOV	M,E
	INX	H
;
L0ADBH:
	MOV	M,D
	DCX	H
;
L0ADDH:
	PUSH	H
	LHLD	SYADR
	XCHG	
	LHLD	L11C5H
	MOV	A,E
	SUB	L
	MOV	E,A
	MOV	A,D
	SBB	H
	MOV	D,A
	POP	H
	DAD	D
	SHLD	L2ED4H
	LDA	0305CH
	STA	L2EA4H
	JMP	L0552H

SASEG:
	JMP	NOTIMPL
SCSEG:
	JMP	NOTIMPL
SDSEG:
	JMP	NOTIMPL
SNAME:
	JMP	NOTIMPL
SPAGE:
	CALL	FILAB
	CALL	SCANE
	CALL	CHKEND
	JZ	L0B25H
	CALL	OPANDE
	LHLD	EVALUE
	LDA	CBUFF
	CPI	' '
	JNZ	CHEND
	CALL	S25AAH
	JMP	CHEND
;
L0B25H:
	CALL	S03ACH
	LDA	PASS
	ORA	A
	CNZ	S25ADH
	JMP	CHEND
SEXITM:
	JMP	SENDM
SEXTRN:
	JMP	NOTIMPL
SLOCAL:
	LDA	L2EA3H
	ORA	A
	JZ	L0BA2H
;
L0B3FH:
	CALL	SCANE
	LDA	TOKEN
	CPI	IDEN
	JNZ	L0BA2H
	LHLD	SYTOP
	PUSH	H
	DCX	H
	SHLD	L3058
	CALL	S1C21H
	XRA	A
	STA	L11DBH
	INR	A
	STA	ACCLEN
	LHLD	L11DEH
	INX	H
	SHLD	L11DEH
	SHLD	NEVAL
	CALL	L0D0EH
	LDA	0300AH
	CPI	030H
	CNZ	ERRO
	LXI	H,03F3FH
	SHLD	ACCUM
	CALL	S1C39H
	POP	H
	SHLD	SYTOP
	DCX	H
	SHLD	L3058
	CALL	S1C24H
	CALL	S1C3CH
	CALL	SCANE
	CALL	CHKEND
	JZ	CHEND
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0BA2H
	LDA	ACCUM
	CPI	02CH
	JZ	L0B3FH
;
L0BA2H:
	CALL	ERRS
	JMP	CHEND
SINPAGE:
	JMP	NOTIMPL
SMACLIB:
	CALL	FILAB	;GET MACLIB FILENAME
	LHLD	L11D6H
	MOV	A,L
	ORA	H
	JNZ	SMACERR	;11D6 NOT ZERO
	LDA	MLFLG	;IF FALSE, PROBLEM
	ORA	A
	JNZ	SMACERR
	CALL	SCANE
	LDA	PASS
	ORA	A
	JNZ	POEND	;JUMP IF PASS 1
	LDA	TOKEN
	CPI	IDEN
	JNZ	SMACERR	;JUMP IF NOT IDENTIFIER
	CALL	OMACLBE
	LDA	PARML
	ORA	A
	CNZ	S25ADH
;
L0BD9H:
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	L0BD9H
	LDA	ACCUM
	CPI	CR
	JZ	L0BF1H
	CPI	EOF
	JNZ	L0BD9H
;
L0BF1H:
	CALL	S03ACH
	CALL	S25A7H
	JMP	SCNEXT

SMACERR:
	CALL	ERRS
	JMP	CHEND

SPUBLIC:
	JMP	NOTIMPL
SSTKLN:
	JMP	NOTIMPL
NOTIMPL:
	CALL	ERRN
;
POEND:	;PSEUDO OPERATOR END - SCAN TO NEXT TOKEN
	CALL	SCANE
	JMP	CHEND
;
CHKEND:	;RETURN ZERO IF END CHARACTER
	LDA	TOKEN
	CPI	SPECL
	RNZ	
	LDA	ACCUM
	CPI	CR
	RZ	
	CPI	'!'
	RZ	
	CPI	';'
	RET	
;
CHKOT:	;CHECK OPCODE TABLE
	SUI	O1
	CPI	O15
	JNC	STERR
	MOV	E,A
	MVI	D,0
	LXI	H,OPTAB
	DAD	D
	DAD	D
	MOV	E,M
	INX	H
	MOV	H,M
	MOV	L,E
	PCHL	

OPTAB:	;OPCODE TABLE
	DW	SSIMP
	DW	SLXI
	DW	SDAD
	DW	SPUSH
	DW	SJMP
	DW	SMOV
	DW	SMVI
	DW	SACCI
	DW	SLDAX
	DW	SLHLD
	DW	SACCR
	DW	SINC
	DW	SINX
	DW	SRST
	DW	RSIN

SSIMP:
	CALL	FILHB
	CALL	SCANE
	JMP	INCPC
SLXI:
	CALL	SHDREG
	CALL	CHCOM
	CALL	SETADR
	JMP	INCPC
SDAD:
	CALL	SHDREG
	JMP	INCPC
SPUSH:
	CALL	SHREG	;SCAN SINGLE PRECISION REGISTER TO A
	CPI	111000B	;MAY BE PSW
	JZ	SPU0
;	NOT PSW, MUST BE B,D, OR H
	ANI	001000B	;LOW BIT MUST BE 0
	CNZ	ERRR	;REGISTER ERROR IF NOT
;
SPU0:	MOV	A,C	;RECALL REGISTER AND MASK IN CASE OF ERROR
	ANI	110000B
	ORA	B	;MASK IN OPCODE FOR PUSH OR POP
	JMP	FILINC	;FILL HEX VALUE AND INCREMENT PC
;
SJMP:	;JMP 16B/ CALL 16B
	CALL	FILHB	;EMIT JMP OR CALL OPCODE
	CALL	SETADR	;EMIT 16BIT OPERAND
	JMP	INCPC
;
SMOV:	;MOV A,B
	CALL	SHREG
	ORA	B	;MASK IN OPCODE
	MOV	B,A	;SAVE IN B TEMPORARILY
	CALL	CHCOM	;MUST BE COMMA SEPARATOR
	CALL	EXP3	;VALUE MUST BE 0-7
	ORA	B	;MASK IN OPCODE
	JMP	FILINC
;
SMVI:	;MOV A,8B
	CALL	SHREG
	ORA	B	;MASK IN OPCODE
	CALL	FILHEX	;EMIT OPCODE
	CALL	CHCOM	;SCAN COMMA
	CALL	SETBYTE	;EMIT 8BIT VALUE
	JMP	INCPC
;
SACCI:	;ADI 8B
	CALL	FILHB	;EMIT IMMEDIATE OPCODE
	CALL	SETBYTE	;EMIT 8BIT OPERAND
	JMP	INCPC
;
SLDAX:	;LDAX B/STAX D
	CALL	SHREG
	ANI	101000B	;MUST BE B OR D
	CNZ	ERRR	;REGISTER ERROR IF NOT
	MOV	A,C	;RECOVER REGISTER NUMBER
	ANI	010000B	;CHANGE TO B OR D IF ERROR
	ORA	B	;MASK IN OPCODE
	JMP	FILINC	;EMIT OPCODE
;
SLHLD:	;LHLD 16B/ SHLD 16B/ LDA 16B/ STA 16B
	CALL	FILHB	;EMIT OPCODE
	CALL	SETADR	;EMIT OPERAND
	JMP	INCPC
;
SACCR:	;ADD B
	CALL	EXP3	;RIGHT ADJUSTED 3BIT VALUE FOR REGISTER
	ORA	B	;MASK IN OPCODE
	JMP	FILINC
;
SINC:	;INR B/DCR D
	CALL	SHREG	;GET REGISTER
	ORA	B
	JMP	FILINC
;
SINX:	;INX H/DCX B
	CALL	SHREG
	ANI	001000B	;MUST BE B D M OR S
	CNZ	ERRR	;REGISTER ERROR IF NOT
	MOV	A,C	;RECOVER REGISTER
	ANI	110000B	;IN CASE OF ERROR
	ORA	B	;MASK IN OPCODE
	JMP	FILINC
;
SRST:	;RESTART 4
	CALL	SHREG	;VALUE IS 0-7
	ORA	B	;OPCODE MASKED
	JMP	FILINC
;
RSIN:	;IN 8B/OUT 8B
	CALL	FILHB	;EMIT OPCODE
	CALL	SETBYTE	;EMIT 8BIT OPERAND
	JMP	INCPC
;
FILINC:	;FILL HEX VALUE FROM A BEFORE INCREMENTING PC
	CALL	FILHEX
;
INCPC:	;CHANGE ASSEMBLER'S PSEUDO PROGRAM COUNTER
	CALL	FILAB
	CALL	SETAS
	JMP	CHEND

L0D04H:
        DB	010H,027H
	DB	0E8H,003H
	DB	064H,000H
	DB	00AH,000H
	DB	001H,000H

L0D0EH:
        MVI     B,5
        LXI H,L0D04H  

L0D13H:
	MOV	E,M
	INX	H
	MOV	D,M
	INX	H
	PUSH	H
	LHLD	NEVAL
	MVI	C,'0'
L0D1DH:
	MOV	A,L
	SUB	E
	MOV	L,A
	MOV	A,H
	SBB	D
	MOV	H,A
	JC	L0D2AH
	INR	C
	JMP	L0D1DH
L0D2AH:
	DAD	D
	SHLD	NEVAL
	LDA	L11DBH
	ORA	A
	JZ	L0D44H
	MOV	A,B
	DCR	A
	JZ	L0D44H
	MOV	A,C
	CPI	030H
	JZ	L0D50H
	XRA	A
	STA	L11DBH

L0D44H:
	LXI	H,ACCLEN
	MOV	E,M
	INR	M
	MVI	D,000H
	LXI	H,ACCUM
	DAD	D
	MOV	M,C
L0D50H:
	POP	H
	DCR	B
	JNZ	L0D13H
	RET	
DELIM:
	LDA	TOKEN
	CPI	SPECL
	CNZ	ERRD
	LDA	ACCUM
	CPI	','
	RZ
	CPI	';'
	RZ
	CPI	CR
	CNZ	ERRD
	RET
;
EXP16:	;GET 16BIT VALUE TO H,L
	PUSH	B
	CALL	SCANE	;GET OPERAND
	CALL	OPANDE	;PROCESS
	LHLD	EVALUE	;H,L = EVALUE
	POP	B
	RET
;
EXP8:	;GET 8BIT VALUE TO REG A
	CALL	EXP16
;
HL2A:	;STORE 8BIT VALUE FROM H,L IN REG-A
	MOV	A,H	;A=H
	ORA	A	;SET ZERO FLAG
	MOV	A,L	;A=L
	RZ		;RETURN OF H=0
	INR	H	;H=H+1
	JNZ	MERRV	;'V' ERROR IF H WAS 01-FE
	ORA	A
	RM		;RETURN IF MINUS

MERRV:
	CALL	ERRV
	MOV	L,A
	RET	

EXP3:
	CALL	EXP8
	CPI	008H
	CNC	ERRV
	ANI	007H
	RET	
SHREG:
	CALL	EXP3
	RAL
	RAL
	RAL
	ANI	038H
	MOV	C,A
	RET	
SHDREG:
	CALL	SHREG
	ANI	008H
	CNZ	ERRR
	MOV	A,C
	ANI	030H
	ORA	B
	JMP	FILHEX
SETBYTE:
	CALL	EXP8
	JMP	FILHEX
SETADR:
	CALL	EXP16
	JMP	FILADR
CHCOM:
	PUSH	PSW
	PUSH	B
	LDA	TOKEN
	CPI	SPECL
	JNZ	COMER
	LDA	ACCUM
	CPI	','
	JZ	COMRET	
COMER:
	MVI	A,'C'
	CALL	PERR

COMRET:
	POP	B
	POP	PSW
	RET	
;
CHEND:	;END OF LINE CHECK
	CALL	FILAB
	LDA	TOKEN
	CPI	SPECL
	JNZ	STERR
	LDA	ACCUM
	CPI	CR
	JNZ	CHEN0
	CALL	SCANE
	JMP	SCNEXT
CHEN0:
	CPI	';'
	JNZ	CHEN2
	CALL	FILAB
CHEN1:
	CALL	SCANE
	LDA	TOKEN
	CPI	SPECL
	JNZ	CHEN1
	LDA	ACCUM
	CPI	LF
	JZ	SCNEXT
	CPI	EOF
	JZ	ENDAS
	CPI	'!'
	JZ	SCNEXT
	JMP	CHEN1
CHEN2:
	CPI	'!'
	JZ	SCNEXT
	CPI	EOF
	JZ	ENDAS

STERR:
	CALL	ERRS
	JMP	CHEN1
DIFF:
	MOV	A,E
	SUB	L
	MOV	L,A
	MOV	A,D
	SBB	H
	MOV	H,A
	RET
;
ENDAS:	;END OF ASSEMBLY FOR THIS PASS
	LDA	L2EA3H
	ORA	A
	JZ	L0E37H
L0E34H:
	CALL	ERRB	;UNBALANCED MACROS
L0E37H:
	XRA	A
	STA	L305A
	LXI	H,PASS
	MOV	A,M
	INR	M	;PASS NUMBER INCREMENTED
	ORA	A
	JNZ	L0E6CH
	LXI	H,TRUE
	SHLD	L11D8H

L0E4AH:
	LHLD	L11D6H	;H,L = 11D6
	MOV	A,H
	ORA	L
	JZ	RESTART	;IF 0, RESTART
	SHLD	SYADR	;SYADR = 11D6
	PUSH	H	;SAVE SYADR
	CALL	GETVALE	;VALUE IN H,L
	XTHL		;VALUE IN SP, SYSADR IN H,L
	PUSH	H	;SAVE SYSADR
	LHLD	L11D8H
	CALL	SETVALE
	POP	H	;H,L = SYADR
	SHLD	L11D8H	;SAVE SYADR IN 11D8
	POP	H	;H,L = VALUE
	SHLD	L11D6H	;SAVE VALUE IN 11D6
	JMP	L0E4AH

L0E6CH:
	CALL	SCANE
	CALL	PADD

	LXI	H,CBUFF+5
	MVI	M,CR
	LXI	H,CBUFF+1
	CALL	PCONE

	LDA	PARMS
	ORA	A
	JZ	L0E8FH
	MVI	A,1
	STA	L2EA4H
	CALL	S25A1H
	CALL	S0FB1H

;
;	COMPUTE REMAINING SPACE
L0E8FH:
	LHLD	SYTOP
	XCHG
	LHLD	SYBASE
	CALL	DIFF	;DIFFERENCE TO H,L
	PUSH	H	;SYTOP-SYBAS TO STACK
	LHLD	SYMAX
	XCHG
	LHLD	SYBASE
	CALL	DIFF	;SYMAX-SYBAS TO H,L
	MOV	E,H
	MVI	D,0	;DIVIDE BY 256
	POP	H	;SYTOP-SYBAS TO H,L
	CALL	DIVFE	;RESULT TO D,E
	XCHG
	CALL	PADDR	;PRINT H,L TO CBUFF
	LXI	H,CBUFF+5
	LXI	D,EMSG

ENDA0:
	LDAX	D
	ORA	A
	JZ	ENDA1
	MOV	M,A
	INX	H
	INX	D
	JMP	ENDA0

EMSG:
	DB	'H USE FACTOR',CR,0

ENDA1:
	LXI	H,CBUFF+2	;BEGINNING OF RATIO
	CALL	PCONE
	LHLD	EPC
	SHLD	FPC	;END PROGRAM COUNTER
	JMP	EOR
;
COMPDH:	;COMPARE D,E WITH H,L FOR EQUALITY (NZ FLAG IF NOT EQUAL)
	MOV	A,D
	CMP	H
	RNZ	
	MOV	A,E
	CMP	L
	RET	
;
SETAS:
	LHLD	FPC
	SHLD	ASPC
	RET	
;
SETLA:	;SYADR=SYLAB, FOLLOWED BY CHECK FOR ZERO
	LHLD	SYLAB
	SHLD	SYADR
	CALL	FOUNDE
	RET	
;
FILAB:	;FILL LABEL VALUE WITH CURRENT ASPC, IF LABEL FOUND
	CALL	SETLA
	RZ		;RETURN IF NO LABEL DETECTED
	LXI	H,0
	SHLD	SYLAB	;TO MARK NEXT STATEMENT WITH NO LABEL
	LDA	PASS
	ORA	A
	JNZ	FIL1
;
;PASS 0
	CALL	GETTYE
	PUSH	PSW	;SAVE A COPY OF TYPE
	ANI	UNDT	;CHECK FOR UNDEFINED
	CNZ	ERRL	;LABEL ERROR
	POP	PSW	;RESTORE TYPE
	ORI	PLABT	;SET TO LABEL TYPE
	CALL	SETTYE	;SET TYPE FIELD
	LHLD	ASPC	;GET CURRENT PC
	CALL	SETVALE	;PLACE INTO VALUE FIELD
	RET
;
FIL1:	;CHECK FOR DEFINED VALUE
	CALL	GETTYE
	ANI	UNDT
	CZ	ERRP	;PHASE ERROR
;	GET VALUE AND COMPARE WITH ASPC
	CALL	GETVALE	;TO H,L
	XCHG		;TO D,E
	LHLD	ASPC
	CALL	COMPDH
	CNZ	ERRP	;PHASE ERROR IF NOT THE SAME
	RET
;
FILHEX:	;WRITE HEX BYTE IN REGISTER A TO MACHINE CODE FILE IF PASS-1
	MOV	B,A
FILHB:	PUSH	B
	LDA	PASS
	ORA	A
	MOV	A,B
	CNZ	DHEXE

;	MAY BE COMPLETELY EMPTY LINE SO CHECK ADDRESS
	LDA	CBUFF+1
	CPI	' '
	LHLD	ASPC
	CZ	PADDR
	LDA	NBP
	CPI	010H
	POP	B
	MOV	A,B
	CC	WHEXB
	LHLD	FPC
	INX	H
	SHLD	FPC
	RET	

FILADR:
	PUSH	H
	MOV	B,L
	CALL	FILHB
	POP	H
	MOV	B,H
	JMP	FILHB

CHEX:
	ADI	'0'
	CPI	03AH
	RC
	ADI	'A'-'0'-10
	RET	
WHEXN:
	CALL	CHEX
	LXI	H,NBP
	MOV	E,M
	MVI	D,0
	INR	M
	LXI	H,CBUFF
	DAD	D
	MOV	M,A
	RET	
WHEXB:
	PUSH	PSW
	RAR
	RAR
	RAR
	RAR
	ANI	00FH
	CALL	WHEXN
	POP	PSW
	ANI	00FH
	JMP	WHEXN

PADD:
	LHLD	ASPC
PADDR:
	XCHG
	LXI	H,NBP
	PUSH	H
	MVI	M,1
	MOV	A,D
	PUSH	D
	CALL	WHEXB
	POP	D
	MOV	A,E
	CALL	WHEXB
	POP	H
	INR	M
	RET	
S0FA1H:
	SUI	041H
	CPI	EOF
	MOV	E,A
	RC	
	ADI	041H
	CPI	03FH
	MVI	E,EOF
	RZ	
	MVI	E,01BH
	RET	
S0FB1H:
	XRA	A
	STA	L2EA5H
	STA	NBP
	LHLD	SYBASE
	SHLD	SYADR
	LXI	H,L2EACH
	MVI	C,038H
	XRA	A
L0FC4H:
	MOV	M,A
	INX	H
	DCR	C
	JNZ	L0FC4H
L0FCAH:
	LHLD	SYADR	;H,L = SYSADR
	XCHG		;D,E = SYSADR
	LHLD	SYTOP	;H,L = SYTOP
	MOV	A,E
	SUB	L
	MOV	A,D
	SBB	H
	JNC	L10A4H
	LHLD	L3062
	CALL	COMPDH
	DCX	H
	SHLD	L3058
	JZ	L0FFDH
	CALL	GETTYE
	CPI	006H
	JNZ	L100BH
	CALL	S1C1EH
L0FF0H:
	ORA	A
	JZ	L0FFDH
	DCR	A
	PUSH	PSW
	CALL	S1C24H
	POP	PSW
	JMP	L0FF0H
L0FFDH:
	CALL	S1C2AH
	ORA	A
	JNZ	L0FFDH
	LHLD	L3058
	INX	H
	JMP	L109EH
L100BH:
	LXI	H,L2EA4H
	CMP	M
	JNZ	L1090H
	LHLD	SYADR
	SHLD	L2EAAH
	INX	H
	SHLD	L3058
	CALL	S1C24H
	LDA	PARMQ
	ORA	A
	JNZ	L103CH
	LDA	ACCLEN
	CPI	002H
	JC	L103CH
	LXI	H,ACCUM
	MOV	A,M
	CPI	03FH
	JNZ	L103CH
	INX	H
	CMP	M
	JZ	L1090H
L103CH:
	LDA	ACCUM
	CALL	S0FA1H
	LXI	H,L2EACH
	MVI	D,000H
	DAD	D
	DAD	D
L1049H:
	SHLD	L2EA8H
	MOV	E,M
	INX	H
	MOV	D,M
	XCHG
	SHLD	SYADR
	MOV	A,L
	ORA	H
	JZ	L107BH
	INX	H
	INX	H
	MOV	A,M
	ANI	00FH
	INR	A
	MOV	C,A
	LXI	D,ACCLEN
	MOV	B,M
L1063H:
	INX	D
	INX	H
	LDAX	D
	CMP	M
	JC	L107BH
	JNZ	L1075H
	DCR	B
	JZ	L107BH
	DCR	C
	JNZ	L1063H
L1075H:
	LHLD	SYADR
	JMP	L1049H
L107BH:
	LHLD	SYADR
	XCHG
	LHLD	L2EAAH
	SHLD	SYADR
	MOV	M,E
	INX	H
	MOV	M,D
	DCX	H
	XCHG
	LHLD	L2EA8H
	MOV	M,E
	INX	H
	MOV	M,D
L1090H:
	LHLD	SYADR
	INX	H
	INX	H
	MOV	A,M
	ANI	00FH
	ADI	4
	MOV	E,A
	MVI	D,0
	DAD	D
L109EH:
	SHLD	SYADR
	JMP	L0FCAH
L10A4H:
	LXI	H,L2EACH
	SHLD	L2EA8H
	MVI	A,01CH
	STA	L2EA7H
L10AFH:
	LHLD	L2EA8H
	MOV	E,M
	INX	H
	MOV	D,M
	INX	H
	SHLD	L2EA8H
	XCHG
	SHLD	SYADR
L10BDH:
	LHLD	SYADR
	MOV	A,L
	ORA	H
	JZ	L1164H
	INX	H
	INX	H
	MOV	A,M
	ANI	00FH
	INR	A
	STA	L2EA6H
	MOV	B,A
	LHLD	SYADR
	INX	H
	INX	H
	SHLD	L3058
	LDA	L2EA5H
	ORA	A
	JZ	L10FAH
	MVI	A,009H
	CALL	S1175H
	LXI	H,L2EA5H
	MOV	A,M
	ANI	0F8H
	ADI	8
	MOV	M,A
	ANI	00FH
	JZ	L10FAH
	MVI	A,008H
	ADD	M
	MOV	M,A
	MVI	A,009H
	CALL	S1175H
L10FAH:
	LDA	L2EA5H
	ADD	B
	ADI	5
	CPI	050H
	JC	L1127H
L1105H:
	LXI	H,NBP
	DCR	M
	MOV	E,M
	MVI	D,0
	DCX	D
	LXI	H,CBUFF
	DAD	D
	MOV	A,M
	CPI	TAB
	JZ	L1105H
	LXI	H,NBP
	MOV	A,M
	MVI	M,0
	STA	CBP
	CALL	S2595H
	XRA	A
	STA	L2EA5H
L1127H:
	CALL	GETVALE
	PUSH	H
	MOV	A,H
	CALL	WHEXB
	POP	H
	MOV	A,L
	CALL	WHEXB
	MVI	A,020H
	CALL	S1175H
	LXI	H,L2EA5H
	MOV	A,M
	ADI	005H
	MOV	M,A
	LDA	L2EA6H
L1143H:
	ORA	A
	JZ	L1157H
	DCR	A
	PUSH	PSW
	CALL	S1C2AH
	CALL	S1175H
	LXI	H,L2EA5H
	INR	M
	POP	PSW
	JMP	L1143H
L1157H:
	LHLD	SYADR
	MOV	E,M
	INX	H
	MOV	D,M
	XCHG
	SHLD	SYADR
	JMP	L10BDH
L1164H:
	LXI	H,L2EA7H
	DCR	M
	JNZ	L10AFH
	LDA	NBP
	STA	CBP
	CALL	S2595H
	RET
S1175H:
	LXI	H,NBP
	MOV	E,M
	MVI	D,0
	INR	M
	LXI	H,CBUFF
	DAD	D
	MOV	M,A
	RET	
ERRR:
	PUSH	PSW
	PUSH	B
	MVI	A,'R'
	CALL	PERR
	POP	B
	POP	PSW
	RET	
ERRV:
	PUSH	PSW
	PUSH	H
	MVI	A,'V'
	CALL	PERR
	POP	H
	POP	PSW
	RET
ERRD:
	PUSH	PSW
	MVI	A,'D'
	JMP	MERR
ERRP:
	PUSH	PSW
	MVI	A,'P'
	JMP	MERR
ERRL:
	PUSH	PSW
	MVI	A,'L'
	JMP	MERR
ERRO:
	PUSH	PSW
	MVI	A,'O'
	JMP	MERR
ERRB:
	PUSH	PSW
	MVI	A,'B'
	JMP	MERR
ERRS:
	PUSH	PSW
	MVI	A,'S'
	JMP	MERR
ERRN:
	PUSH	PSW
	MVI	A,'N'	;NOT IMPLEMENTED
MERR:
	CALL	PERR
	POP	PSW
	RET
L11C2H:
	DB	0
SYLAB:	DW	0	;ADDRESS OF LINE LABEL

L11C5H:
	DB	0
	DB	0
EPC:	DW	0	;END PC VALUE
NBP:	DB	0	;NEXT BYTE POSITION TO WRITE FOR MACHINE CODE
L11CAH:
	DB	0
L11CBH:
	DB	0
L11CCH:
	DB	0
IFCNT:	DB	0	;IF NESTING COUNT
IFSTK:	DB	0	;IF ELSE STACK 1=IF 2=ELSE
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
L11D6H: DW	0
L11D8H: DW	0
L11DAH:
	DB	0
L11DBH:
	DB	0
NEVAL:	DW	0	;% EVALULATION
L11DEH: DW	0
L11E0H:
	DB	0
	DB	0
L11E2H:
	DB	0
	DB	0
S11E4H:
	LHLD	L11E2H
	CALL	COMPDH
	RNZ
	MVI	M,0
	RET	
S11EEH:
	SHLD	L2EF4H
	MOV	A,M
	CPI	CR
	RNZ
	MVI	M,0
	RET	

;
; THESE DB ARE TO MAKE THE ORIGINAL MAC.COM MATCH BYTE FOR BYTE
; WHEN COMPARING THIS VERSION AND CAN BE REMOVED WHEN DONE
;
L11F8H:	DB	000H,000H,000H,000H,000H,000H,001H,017H


ENDAS6M	EQU	($ AND 0FF00H) + 100H


;***************************************************************

	TITLE	'ASM OPERAND SCAN MODULE'
;	OPERAND SCAN MODULE

	ORG	1200H

OSMAX	EQU	10
VSMAX	EQU	8*2
;
;
;	BEGINNING OF MODULE
	JMP	01600H
OPANDE:
	JMP	OPAND	;SCAN OPERAND FIELD
	JMP	MULF	;MULTIPLY FUNCTION
DIVFE:
	JMP	DIVE	;DIVIDE FUNCTION
UNARY:	DS	1	;TRUE IF OPERATOR IS UNARY
OPERV:	DS	OSMAX	;OPERATOR STACK
HIERV:	DS	OSMAX	;OPERATOR PRIORITY
VSTACK:	DS	VSMAX	;VALUE STACK
OSP:	DS	1	;OPERATOR STACK POINTER
VSP:	DS	1	;VALUE STACK POINTER
;
;
;
STKV:	;PLACE CURRENT H,L VALUE AT TOP OF VSTACK
	XCHG		;HOLD VALUE IN D,E
	LXI	H,VSP
	MOV	A,M
	CPI	VSMAX
	JC	STKV0
	CALL	ERREX	;OVERFLOW IN EXPRESSION
	MVI	M,0	;VSP = 0
STKV0:
	MOV	A,M	;GET VSP
	INR	M	;VSP=VSP+1
	INR	M	;VSP=VSP+2
	MOV	C,A	;SAVE VSP
	MVI	B,0	;DOUBLE VSP
	LXI	H,VSTACK
	DAD	B
	MOV	M,E	;LOW BYTE
	INX	H
	MOV	M,D	;HIGH BYTE
	RET
;
STK0:	;STACK OPERATOR (REG-A) AND PRIORITY (REG-B)
	PUSH	PSW	;SAVE IT
	LXI	H,OSP
	MOV	A,M
	CPI	OSMAX
	JC	STK01
	MVI	M,0
	CALL	ERREX	;OPERATOR STACK OVERFLOW
STK01:	MOV	E,M	;GET OSP
	MVI	D,0
	INR	M	;OSP=OSP+1
	POP	PSW	;RECALL OPERATOR
	LXI	H,OPERV
	DAD	D	;OPSERV(OSP)
	MOV	M,A	;OPSERV(OSP)=OPERATOR
	LXI	H,HIERV
	DAD	D
	MOV	M,B	;HIERV(OSP)=PRIORITY
	RET
;
LODV1:	;LOAD TOP ELEMENT FROM VSTACK TO H,L
	LXI	H,VSP
	MOV	A,M
	ORA	A
	JNZ	LODOK	
	CALL	ERREX	;UNDERFLOW
	LXI	H,0
	RET
;
LODOK:
	DCR	M
	DCR	M	;VSP=VSP-2
	MOV	C,M	;LOW BYTE
	MVI	B,0
	LXI	H,VSTACK
	DAD	B	;VSTACK(VSP)
	MOV	C,M	;GET LOW BYTE
	INX	H
	MOV	H,M
	MOV	L,C
	RET
;
LODV2:	;LOAD TOP TWO ELEMENTS DE HOLDS TOP, HL HOLDS TOP-1
	CALL	LODV1
	XCHG
	CALL	LODV1
	RET
;
APPLY:	;APPLY OPERATOR IN REG-A TO TOP OF STACK
	MOV	L,A	;OPERATOR NUMBER IN L
	MVI	H,0
	DAD	H	;OPERATOR NUMBER*2
	LXI	D,ALRTAB
	DAD	D	;INDEXED ALRTAB
	MOV	E,M	;LOW ADDRESS
	INX	H
	MOV	H,M	;HIGH ADDRESS
	MOV	L,E
	PCHL		;SET PC AND GO TO SUBROUTINE

;	ALR OPERAND TABLE
ALRTAB:	DW	MULOP	;X1
	DW	DIVOP	;X2
	DW	MODOP	;X3
	DW	SHLOP	;X4
	DW	SHROP	;X5
	DW	ADDOP	;X6
	DW	SUBOP	;X7
	DW	NEGOP	;X8
	DW	EQOP	;X9
	DW	LTOP	;X10
	DW	LEOP	;X11
	DW	GTOP	;X12
	DW	GEOP	;X13
	DW	NEOP	;X14
	DW	NOTOP	;X15
	DW	ANDOP	;X16
	DW	OROP	;X17
	DW	XOROP	;X18
	DW	HIGHOP	;X19
	DW	LOWOP	;X20
	DW	ERREX	;(
;
;	SPECIFIC HANDLERS FOLLOW
SHFT:	;SET UP OPERANDS FOR SHIFT L AND R
	CALL	LODV2
	MOV	A,D	;ENSURE 0-15
	ORA	A
	JNZ	SHERR
	MOV	A,E
	CPI	17
	RC		;RETURN IF 0-16 SHIFT
SHERR:	CALL	ERREX
	MVI	A,16
	RET
;
NEGF:	;COMPUTE 0-H,L TO H,L
	XRA	A
	SUB	L
	MOV	L,A
	MVI	A,0
	SBB	H
	MOV	H,A
	RET
;
DIVF:	CALL	LODV2
DIVE:	;(EXTERNAL ENTRY FROM MAIN PROGRAM)
	XCHG		;SWAP D,E WITH H,L FOR DIVIDE FUNCTION
;	COMPUTE X/Y WHERE X IS IN D,E AND Y IS IN H,L
;	THE VALUE OF X/Y APPEARS IN D,E AND X MOD Y IS IN H,L
;
	SHLD	DTEMP	;SAVE X IN TEMPORARY
	LXI	H,BNUM	;STORE BIT COUNT
	MVI	M,011H
	LXI	B,0	;INITIALIZE RESULT
	PUSH	B
	XRA	A	;CLEAR FLAGS
DLOOP:
	MOV	A,E	;GET LOW Y BYTE
	RAL
	MOV	E,A
	MOV	A,D
	RAL
	MOV	D,A
	DCR	M	;DECREMENT BIT COUNT
	POP	H	;RESTORE TEMP RESULT
	RZ		;ZERO BIT COUNT MEANS ALL DONE
	MVI	A,0	;ADD IN CARRY
	ACI	0	;CARRY
	DAD	H	;SHIFT TEMP RESULT LEFT ONE BIT
	MOV	B,H	;COPY H AND L TO A AND C
	ADD	L
	LHLD	DTEMP	;GET ADDRESS OF X
	SUB	L	;SUBTRACT FROM TEMPORARY RESULT
	MOV	C,A
	MOV	A,B
	SBB	H
	MOV	B,A
	PUSH	B	;SAVE TEMP RESULT IN STACK
	JNC	DSKIP	;NO BORROW FROM SUBTRACT
	DAD	B	;ADD X BACK IN
	XTHL		;REPLACE TEMP RESULT ON STACK
DSKIP:	LXI	H,BNUM	;RESTORE H,L
	CMC
	JMP	DLOOP	;REPEAT LOOP STEPS
;
DTEMP:	DW	0
BNUM:	DB	0
;
MULF:	;MULTIPLY D,E BY H,L AND REPLACE H,L WITH RESULT
	MOV	B,H
	MOV	C,L	;COPY OF 1ST VALUE TO B,C FOR SHIFT AND ADD
	LXI	H,0	;H,L IS THE ACCUMULATOR
MUL0:	XRA	A
	MOV	A,B	;CARRY IS CLEARED
	RAR
	MOV	B,A
	MOV	A,C
	RAR
	MOV	C,A
	JC	MUL1	;SKIP THIS ADD IF LSB IS ZERO
	ORA	B
	RZ		;RETURN WITH H,L
	JMP	MUL2	;SKIP ADD
MUL1:	DAD	D	;ADD CURRENT VALUE OF D
MUL2:	XCHG		;READY FOR *2
	DAD	H
	XCHG
	JMP	MUL0
;
MULOP:	;MULTIPLY D,E BY H,L
	CALL	LODV2
	CALL	MULF
	JMP	ENDOP
;
DIVOP:	;DIVIDE H,L BY D,E
	CALL	DIVF
	XCHG		;RESULT TO H,L
	JMP	ENDOP
;
MODOP:
	CALL	DIVF
	JMP	ENDOP
;
SHLOP:	CALL	SHFT	;CHECK VALUES
SHL0:	ORA	A	;DONE?
	JZ	ENDOP
	DAD	H	;HL=HL*2
	DCR	A
	JMP	SHL0
;
SHROP:	CALL	SHFT
SHR0:	ORA	A	;DONE?
	JZ	ENDOP
	PUSH	PSW	;SAVE CURRENT COUNT
	XRA	A
	MOV	A,H
	RAR
	MOV	H,A
	MOV	A,L
	RAR
	MOV	L,A
	POP	PSW
	DCR	A
	JMP	SHR0
;
ADDOP:	CALL	LODV2
ADD0:	DAD	D
	JMP	ENDOP
;
SUBOP:	CALL	LODV2
	XCHG		;TREAT AS HL+(-DE)
	CALL	NEGF	;0-HL
	JMP	ADD0
;
NEGOP:	CALL	LODV1
NEG0:	CALL	NEGF
	JMP	ENDOP
;
COMP16:	;RETURN ZERO IF H,L=D,E
	MOV	A,D
	CMP	H
	RNZ	
	MOV	A,E
	CMP	L
	RET

EQOP:
	CALL	LODV2
	CALL	COMP16	;COMPARE H,L TO D,E
	JNZ	RFALSE	;NOT EQUAL
	JMP	RTRUE

LTOP:
	CALL	LODV2

;
ISLT:	;IS LESS THAN?
	MOV	A,L
	SUB	E
	MOV	A,H
	SBB	D
	JC	RTRUE
	JMP	RFALSE
;
LEOP:
	CALL	LODV2
LEOP0:
	CALL	COMP16
	JZ	RTRUE
	JMP	ISLT
;
GTOP:
	CALL	LODV2
	XCHG
	JMP	ISLT
;
GEOP:
	CALL	LODV2
	XCHG
	JMP	LEOP0
;
NEOP:
	CALL	LODV2
	CALL	COMP16
	JNZ	RTRUE
	JMP	RFALSE
;
RTRUE:	;RETURN TRUE (FFFFH)
	LXI	H,TRUE
	JMP	ENDOP
;
RFALSE:	;NOT EQUAL
	LXI	H,FALSE
	JMP	ENDOP
;
NOTOP:	;RETURN NOT H,E IN H,E
	CALL	LODV1
	INX	H
	JMP	NEG0
;
ANDOP:	;D,E AND H,L RETURN IN H,L
	CALL	LODV2
	MOV	A,D
	ANA	H
	MOV	H,A
	MOV	A,E
	ANA	L
	MOV	L,A
	JMP	ENDOP
;
OROP:	;D,E OR H,L RETURN IN H,L
	CALL	LODV2
	MOV	A,D
	ORA	H
	MOV	H,A
	MOV	A,E
	ORA	L
	MOV	L,A
	JMP	ENDOP
;
XOROP:	;D,E XOR H,L RETURN IN H,L
	CALL	LODV2
	MOV	A,D
	XRA	H
	MOV	H,A
	MOV	A,E
	XRA	L
	MOV	L,A
	JMP	ENDOP
;
HIGHOP:	;RETURN HIGH ORDER BYTE IN L
	CALL	LODV1
	MOV	L,H	;HIGH ORDER BYTE IN L
	JMP	HLCLRH	;CLEAR H
;
LOWOP:	;RETURN LOW ORDER BYTE IN L
	CALL	LODV1	;LOW ORDER BYTE IN L
;
HLCLRH:
	MVI	H,0

ENDOP:
	JMP	STKV
;
;
;
ENDEXP:	;RETURNS ZERO FLAG IF SYMBOL IS CR, ;, OR EXCLAMATION
	LDA	TOKEN
	CPI	SPECL
	RNZ		;NOT END OF NOT SPECIAL
;
	LDA	ACCUM
	CPI	CR
	RZ
	CPI	';'
	RZ
	CPI	'!'
	RET
;
ENDEXPC:;RETURNS ZERO FLAG IF SYMBOL IS CR, ;, EXCLAMATION, OR ,
	CALL	ENDEXP
	RZ
	CPI	','
	RET
;
OPAND:	;SCAN THE OPERAND FIELD OF AN INSTRUCTION 
;       (NOT A DB WITH FIRST TOKEN STRING > 2 OR 0)
	XRA	A
	STA	OSP	;ZERO OPERATOR STACK POINTER
	STA	VSP
	DCR	A	;255
	STA	UNARY
	LXI	H,0
	SHLD	EVALUE	;CLEAR EVALUE
;
OP0:	;ARRIVE HERE WITH NEXT ITEM ALREADY SCANNED
	CALL	ENDEXPC	;DONE?
	JNZ	OP1	;NOPE.
;EMPTY THE OPERATOR STACK
EMPOP:	LXI	H,OSP
	MOV	A,M	;GET THE OSP AND CHECK FOR EMPTY
	ORA	A
	JZ	CHKVAL	;JUMP IF EMPTY
	DCR	M	;POP ELEMENT
	MOV	E,A	;COPY FOR DOUBLE ADD
	DCR	E	
	MVI	D,0
	LXI	H,OPERV
	DAD	D	;INDEXED - OPERV(OSP)
	MOV	A,M	;GET OPERATOR
	CALL	APPLY	;APPLY OPERATOR
	JMP	EMPOP
;
CHKVAL:
	LDA	VSP	;MUST HAVE ONE ELEMENT IN THE STACK
	CPI	2
	CNZ	ERREX
	LDA	CBUFF
	CPI	' '
	RNZ		;EVALUE REMAINS AT ZERO
	LHLD	VSTACK	;GET DOUBLE BYTE IN STACK
	SHLD	EVALUE
	RET
;
OP1:	;MORE TO SCAN
	LDA	CBUFF
	CPI	' '
	JNZ	GETOP
	LDA	TOKEN
	CPI	STRNG	;IS THIS A STRING?
	JNZ	OP3	;NO
;
;	STRING - CONVERT DOUBLE PRECISION
	LDA	ACCLEN	;IS THE ACCUMULATOR EMPTY?
	ORA	A
	CZ	ERREX	;ERROR IF LENGTH=0
	CPI	3
	CNC	ERREX	;ERROR IF LENGTH>2
	MVI	D,0
	LXI	H,ACCUM
	MOV	E,M	;LSBYTE
	INX	H
	DCR	A	;A HAS THE LENGTH
	JZ	OP2	;ONE OR TWO BYTES
	MOV	D,M	;FILL HIGH ORDER
;
OP2:	XCHG		;VALUE (D,E) TO H,L
	JMP	STNUM	;STORE TO STACK
;
OP3:	;NOT A STRING, CHECK FOR NUMBER
	CPI	NUMB
	JNZ	OP4
	LHLD	VALUE	;NUMERIC VALUE
	JMP	STNUM
;
OP4:	;NOT STRING OR NUMBER, MUST BE ID OR SPECL
	CALL	BGETE	;BINARY SEARCH, GET ATTRIBUTES
	JNZ	OP6	;JUMP IF MATCH NOT FOUND
;	MATCH FOUND, MAY BE OPERATOR
	CPI	OPER+1
	JNC	OP5	;NOT AN OPERATOR
;	OPERATOR ENCOUNTERED MS NIBBLE OF B IS PRIORITY NUMBER IS LS NIBBLE
;	IS THE OPERATOR
;	REG-A HAS THE OPERATOR NUMBER, B HAS PRIORITY
	CPI	NULF	;NUL?
	JNZ	OPER0	;NOT NUL
;	FOUND NUL
	CALL	S160CH
	CALL	ENDEXP
	JZ	L14E8H
	LDA	TOKEN
	CPI	STRNG
	JNZ	L14D9H
	LDA	ACCLEN
	ORA	A
	JNZ	L14D9H
	CALL	SCANE
	CALL	ENDEXPC
	JZ	L14E8H
L14D9H:
	CALL	S160CH
	CALL	ENDEXP
	JNZ	L14D9H
	LXI	H,0
	JMP	L14EBH
L14E8H:
	LXI	H,TRUE
L14EBH:
	CALL	STNUM0
	JMP	OP0
OPER0:
	CPI	LPAR	;(?
	MOV	C,A
	LDA	UNARY
	JNZ	OPER1	;JUMP IF NOT A (
;	( ENCOUNTERED, UNARY MUST BE TRUE
	ORA	A
	CZ	ERREX
	MVI	A,TRUE
	STA	UNARY	;UNARY IS SET TRUE
	MOV	A,C	;RECOVER OPERATOR
	JMP	OPER4	;CALLS STK0 AND SETS UNARY TO TRUE
;
OPER1:	;NOT A LEFT PAREN
	ORA	A
	JNZ	OPER6	;MUST BE + OR - SINCE UNARY IS SET
;
;	UNARY NOT SET, MUST BE BINARY OPERATOR
OPER2:	;COMPARE HIERARCHY OF TOS
	PUSH	B	;SAVE PRIORITY AND OPERATOR NUMBER
	LDA	OSP
	ORA	A
	JZ	OPER3	;NO MORE OPERATORS IN STACK
	MOV	E,A	;OSP TO E
	DCR	E	;OSP-1
	MVI	D,0
	LXI	H,HIERV
	DAD	D	;HL ADDRESSES TOP OF OPERATOR STACK
	MOV	A,M	;PRIORITY OF TOP OPERATOR
	CMP	B	;CURRENT GREATER?
	JC	OPER3	;JUMP IF SO
;	APPLY TOP OPERATOR TO VALUE STACK
	LXI	H,OSP
	MOV	M,E
	LXI	H,OPERV
	DAD	D
	MOV	A,M	;OPERATOR NUMBER TO ACC
	CALL	APPLY
	POP	B	;RESTORE OPERATOR NUMBER AND PRIORITY
	JMP	OPER2	;FOR ANOTHER TEST
;
OPER3:	;ARRIVE HERE WHEN OPERATOR IS STACKED
;	CHECK FOR RIGHT PAREN BALANCE
	POP	B	;OPERATOR IN C, PRIORITY IN B
	MOV	A,C
	CPI	RPAR
	JNZ	OPER4	;JUMP IF NOT A RIGHT PAREN
;
;	RIGHT PAREN FOUND, STACK MUST CONTAIN LEFT PAREN TO DELETE
	LXI	H,OSP
	MOV	A,M
	ORA	A	;ZERO
	JZ	LPERR	;PAREN ERROR IF SO
	DCR	A	;OSP-1
	MOV	M,A	;STORED TO MEMORY
	MOV	E,A
	MVI	D,0
	LXI	H,OPERV
	DAD	D
	MOV	A,M	;TOP OPERATOR IN REG-A
	CPI	LPAR
	JZ	NLERR	;JMP IF NO ERROR - PARENS BALANCE
LPERR:	CALL	ERREX
NLERR:	;ERROR REPORTING COMPLETE
	XRA	A
	JMP	OPER5	;TO CLEAR UNARY FLAG
;
OPER4:	;ORDINARY OPERATOR
	CALL	STK0
	MVI	A,TRUE
OPER5:	STA	UNARY
	JMP	GETOP	;FOR ANOTHER ELEMENT
;
OPER6:	;UNARY SET, MUST BE + OR -
	MOV	A,C	;RECALL OPERATOR
	CPI	PLUS
	JZ	GETOP	;IGNORE UNARY PLUS
	CPI	MINUS
	JNZ	CHKNOT
	INR	A	;CHANGE TO UNARY MINUS
	MOV	C,A
	JMP	OPER2
CHKNOT:	;UNARY NOT SYMBOL, HIGH, OR LOW
	CPI	NOTF
	JZ	OPER2
	CPI	HIGHF
	JZ	OPER2
	CPI	LOWF
	CNZ	ERREX
	JMP	OPER2
;
;
OP5:	;ELEMENT FOUND IN TABLE NOT AN OPERATOR
	CPI	PT	;PSEUDO OPERATOR?
	CZ	ERREX	;ERROR IF SO
	MOV	L,B	;GET LOW VALUE TO L
	MVI	H,0	;ZERO HIGH ORDER BYTE
	JMP	STNUM	;STORE IT
;
OP6:	;NOT FOUND IS TABLE SCAN, $?
	LDA	TOKEN
	CPI	SPECL
	JNZ	OP7
	LDA	ACCUM
	CPI	'$'
	JZ	CURPC	;USE CURRENT PC
	CALL	ERREX
	LXI	H,0
	JMP	STNUM
CURPC:	LHLD	ASPC	;GET CURRENT PC
	JMP	STNUM
;
OP7:	;NOT $, LOOK IT UP
	CALL	LOOKUPE
	CALL	FOUNDE
	JNZ	FIDENT
;	NOT FOUND IN SYMBOL TABLE, ENTER IF PASS 1
	MVI	A,'P'
	CALL	PERR
	CALL	ENTERE	;ENTER SYMBOL WITH ZERO TYPE FIELD
	JMP	FIDE0
FIDENT:	CALL	GETTYE	;TYPE TO H,L
	ANI	UNDT
	MVI	A,'U'
	CZ	PERR
;
FIDE0:
	CALL	GETVALE	;VALUE TO H,L
;
STNUM:
	CALL	STNUM0
;
GETOP:
	CALL	SCANE
	JMP	OP0
;
STNUM0:	;STORE H,L TO VALUE STACK
	LDA	UNARY
	ORA	A	;UNARY OPERATION SET
	CZ	ERREX	;OPERAND ENCOUNTERED WITH UNARY OFF
	XRA	A
	STA	UNARY	;SET TO OFF
	JMP	STKV	;STACK THE VALUE
;
ERREX:	;PUT 'E' ERROR IN OUTPUT BUFFER
	PUSH	H
	MVI	A,'E'
	CALL	PERR
	POP	H
	RET	

;
; THESE DB ARE TO MAKE THE ORIGINAL MAC.COM MATCH BYTE FOR BYTE
; WHEN COMPARING THIS VERSION AND CAN BE REMOVED WHEN DONE
;
L15ECH:	DB	000H,000H,000H,000H,000H,000H,000H,000H
L15F4H:	DB	000H,000H,000H,000H,000H,000H,000H,000H
L15FCH:	DB	000H,000H,000H,000H


ENDAS5M	EQU	($ AND 0FF00H) + 100H


;;
;; AS2SCAN
;;
	TITLE	'ASM SCANNER MODULE'
	ORG	1600H

	JMP	L1C00H
INITSE:
	JMP	INITS
SCANE:
	JMP	SCAN
S1609H:
	JMP	L1666H
S160CH:
	JMP	L1AFCH
LASTC:
	DB	EOF
STYPE:
	DB	0
	DB	0
	DB	0
L1613H:
	DB	0
	DB	0
	DB	0
BNL:	DS	1	;BRACKET NEST LEVEL?
L1617H:
	LXI	B,03A1AH
	ANA	E
	MVI	L,0B7H
	JZ	L164FH
	LHLD	L2EF4H
	MOV	A,M
	ORA	A
	JNZ	L1648H
	LDA	L2EA4H
	CPI	2
	JZ	L163DH
	LXI	H,L1617H+1
	INR	M
	MVI	A,000H
	RNZ
	CALL	SERRB
	CALL	S2595H
L163DH:
	CALL	S1C30H
	LDA	L2F14H
	ORA	A
	RNZ
	JMP	L1617H+2
L1648H:
	INX	H
	SHLD	L2EF4H
	JMP	020D8H
L164FH:
	CALL	S2586H
	STA	L1617H+1
	MOV	B,A
	LDA	TOKEN
	CPI	STRNG
	MOV	A,B
	RZ	
	CPI	'A' OR 1100000B	;CARRY IF LESS THAN LOWER A 165D	FE 61 	. A 
	RC	
	CPI	('Z' OR 1100000B)+1	;LOWER CASE Z 1660	FE 7B 	. { 
	RNC 	
	ANI	1011111B	;TO UPPER CASE
	RET	
L1666H:
	PUSH	PSW
	CPI	CR
	JZ	L1687H
	CPI	LF
	JZ	L1687H
	LDA	CBP
	CPI	CBMAX
	JNC	L1687H	;CONSOLE BUFFER OVERFLOW
	MOV	E,A
	MVI	D,0
	INR	A
	STA	CBP
	LXI	H,CBUFF
	DAD	D
	POP	PSW
	MOV	M,A
	RET	
L1687H:
	POP	PSW
	RET	
S1689H:
	LDA	L2F65H
	CALL	S1853H
	RNZ	
	LDA	L2F65H
	CALL	NUMT
	RET	
S1697H:
	XRA	A
	STA	L2F66H
	STA	L2F64H
	CALL	L1617H+2
	STA	L2F65H
	LDA	TOKEN
	CPI	COMM
	RZ	
	LDA	L2F65H
	CPI	128
	JC	L16C6H
	CALL	S210CH
	STA	L2F66H
	LXI	D,L2F67H
L16BBH:
	MOV	A,M
	STAX	D
	INX	H
	INX	D
	DCR	B
	JNZ	L16BBH
	JMP	L16E5H
L16C6H:
	CALL	S1853H
	RZ
L16CAH:
	CALL	S1689H
	JZ	L16F0H
	LXI	H,L2F66H
	MOV	A,M
	CPI	00FH
	JNC	L16EEH
	INR	M
	LXI	H,L2F67H
	MOV	E,A
	MVI	D,0
	DAD	D
	LDA	L2F65H
	MOV	M,A
L16E5H:
	CALL	L1617H+2
	STA	L2F65H
	JMP	L16CAH
L16EEH:
	XRA	A
	RET	
L16F0H:
	XRA	A
	INR	A
	RET	
S16F3H:
	LHLD	SYADR
	SHLD	L1613H
	CALL	S1C33H
	CALL	S1C36H
	RNZ
	LHLD	L1613H
	SHLD	SYADR
	RET	
S1707H:
	XRA	A
	STA	L1617H
L170BH:
	LXI	H,L1617H
	INR	M
	JNZ	L171DH
	CALL	SERRO
	LXI	H,L2F66H
	MVI	M,0
	SHLD	L2EF4H
L171DH:
	LXI	H,L2F66H
	MOV	A,M
	ORA	A
	JZ	L1735H
	DCR	M
	LXI	H,L2F64H
	MOV	E,M
	INR	M
	MVI	D,0
	LXI	H,L2F67H
	DAD	D
	MOV	A,M
	JMP	L1666H
L1735H:
	LDA	L2EA3H
	ORA	A
	LDA	L2F65H
	JNZ	L174AH
	MOV	B,A
	ORA	A
	JNZ	L1777H
	CALL	L1617H+2
	JMP	L1666H
L174AH:
	ORA	A
	JZ	L177FH
	CPI	'^'
	JNZ	L176CH
	CALL	S1697H
	MVI	B,05EH
	JNZ	L177BH
	LDA	L2F65H
	CPI	'&'
	JNZ	L177BH
	LXI	H,L2F66H
	INR	M
	INX	H
	MOV	M,A
	JMP	L1777H
L176CH:
	CPI	026H
	JZ	L179EH
	MOV	B,A
	CPI	07FH
	JZ	L17B1H
L1777H:
	XRA	A
	STA	L2F65H
L177BH:
	MOV	A,B
	JMP	L1666H
L177FH:
	CALL	S1697H
	JZ	L170BH
	LDA	L2F65H
	CPI	026H
	JZ	L1795H
	LDA	TOKEN
	CPI	STRNG
	JZ	L170BH
L1795H:
	CALL	S16F3H
	JZ	L170BH
	JMP	L17BDH
L179EH:
	CALL	S1697H
	MVI	B,026H
	JZ	L177BH
	CALL	S16F3H
	MVI	B,026H
	JZ	L177BH
	JMP	L17BDH
L17B1H:
	CALL	S1697H
	JZ	L170BH
	CALL	S16F3H
	JZ	L170BH
L17BDH:
	LXI	H,L2F65H
	MOV	A,M
	CPI	026H
	JNZ	L17C8H
	MVI	A,07FH
L17C8H:
	MVI	M,000H
	STA	L2F14H
	CALL	S1C2DH
	LXI	H,L2EA4H
	MVI	M,2
	LHLD	SYMAX
	SHLD	L2F24H
	CALL	S1C42H
	SHLD	L2EF4H
	XRA	A
	STA	L2F66H
	LHLD	L1613H
	SHLD	SYADR
	CALL	S1697H
	JMP	L170BH
INITS:
	CALL	ZERO
	STA	L2F66H
	STA	L2F65H
	STA	NEXTC
	STA	CBP
	MVI	A,LF
	STA	LASTC
	CALL	S2595H
	MVI	A,16	;START OF SOURCE LINE
	STA	CBP
	RET	
ZERO:
	XRA	A
	STA	ACCLEN
	STA	STYPE
	RET	
;
SAVER:	;STORE THE NEXT CHARACTER IN THE ACCUMULATOR AND UDPATE
	LXI	H,ACCLEN
	MOV	A,M
	CPI	ACMAX
	JC	SAV1	;JUMP IF NOT LAST POSITION
	MVI	M,0
	CALL	SERRO
SAV1:
	MOV	E,M	;D,E WILL HOLD INDEX
	MVI	D,0	;
	INR	M	;ACCLEN IS INCREMENTED
	INX	H	;ADDRESS ACCUMULATOR
	DAD	D	;ADD INDEX TO ACCUMULATOR
	LDA	NEXTC	;GET CHARACTER
	MOV	M,A	;INTO ACCUMULATOR
	RET
;
TDOLL:	;TEST FOR DOLLAR SIGN, ASSUMING H,L ADDRESS NEXTC
	MOV	A,M
	CPI	'$'
	RNZ
	XRA	A
	MOV	M,A
	RET	
;
NUMERIC:;CHECK NEXTC FOR NUMERIC, RETURN ZERO FLAG IF NOT NUMERIC
	LDA	NEXTC
NUMT:
	SUI	'0'
;	CARRY RESET IF NUMERIC
	CPI	10
	RAL	
	ANI	1B	;ZERO IF NOT NUMERIC
	RET	
HEX:
	CALL	NUMERIC
	RNZ
	LDA	NEXTC
	SUI	'A'
	CPI	6
	RAL
	ANI	1
	RET	
LETTER:	;RETURN ZERO FLAG IF NEXTC IS NOT A LETTER
	LDA	NEXTC
S1853H:
	CPI	'?'
	JZ	L1865H
	CPI	'@'
	JZ	L1865H
	SUI	'A'
	CPI	EOF
	RAL	
	ANI	001H
	RET	
L1865H:
	ORA	A
	RET	
ALNUM:	;RETURN ZERO FLAG IF NOT ALPHANUMERIC
	CALL	LETTER
	RNZ
	CALL	NUMERIC
	RET	
S186FH:
	CPI	' '
	RNC 	
	CPI	TAB
	RZ	
	CPI	CR
	RZ	
	CPI	LF
	RZ	
	CPI	EOF
	RZ	
	JMP	SERRI
;
GNCN:	;GET CHARACTER AND STORE TO NEXTC
	CALL	S1707H
	CALL	S186FH
	STA	NEXTC
	LDA	L305A
	ORA	A
	JZ	L18A6H
	LDA	0305CH
	CPI	1
	JNZ	L18A0H
	LDA	PASS
	ORA	A
	JNZ	L18A6H
L18A0H:
	LDA	NEXTC
	CALL	S1C27H
L18A6H:
	LDA	NEXTC
	RET	
EOLT:
	CPI	CR
	RZ	
	CPI	EOF
	RZ	
	CPI	'!'
	RET	
SCAN:
	CALL	ZERO
;
;	DEBLANK
DEBL:
	XRA	A
	STA	TOKEN
	LDA	NEXTC
	CPI	TAB	;TAB?
	JZ	DEB0
	CPI	';'
	JNZ	L192FH
	MVI	A,COMM
	STA	TOKEN	;SET TOKEN = COMMENT
	LDA	L305A	;MACRO?
	ORA	A
	JZ	DEB1
	LDA	0305CH
	CPI	1
	JNZ	L18E2H
	LDA	PASS
	ORA	A
	JNZ	DEB1	;JUMP IF PASS 1
L18E2H:
	CALL	GNCN
	CPI	';'
	JNZ	L1942H	;NOT A SEMI-COLON
	LHLD	L3060
	XCHG	
	LHLD	L3058
	DCX	H
	DCX	H
L18F3H:
	MOV	A,E
	CMP	L
	JNZ	L18FDH
	MOV	A,D
	CMP	H
	JZ	L1911H
L18FDH:
	MOV	A,M
	CPI	00AH
	JNZ	L1908H
	DCX	H
	DCX	H
	JMP	L1911H
L1908H:
	CPI	'!'
	JNC	L1911H
	DCX	H
	JMP	L18F3H
L1911H:
	SHLD	L3058
	LDA	L305A
	PUSH	PSW
	XRA	A
	STA	L305A
L191CH:
	CALL	GNCN
	CALL	EOLT	;CR, EOF, OR EXCLAMATION?
	JNZ	L191CH	;JUMP IF NO
	CALL	S1C27H
	POP	PSW
	STA	L305A
	JMP	FINDL
L192FH:
	LDA	NEXTC	;IF NEXT CHARACTER IS *
	CPI	'*'
	JNZ	DEB2	;JUMP
	LDA	LASTC	;IF LAST CHARACTER WAS NOT EOF
	CPI	LF
	JNZ	DEB2	;JUMP
;	COMMENT FOUND, REMOVE IT
DEB1:	CALL	GNCN
L1942H:
	CALL	EOLT	;CR, EOF, OR EXCLAMATION?
	JZ	FINDL	;JUMP IF YES
	JMP	DEB1
DEB2:
	ORI	' '
	CPI	' '
	JNZ	FINDL
DEB0:
	CALL	GNCN
	JMP	DEBL
;
;	LINE DEBLANKED, FIND TOKEN TYPE
FINDL:	;LOOK FOR LETTER, DECIMAL DIGIT, OR STRING QUOTE
	XRA	A
	STA	TOKEN	;ZERO TOKEN
	CALL	LETTER
	JZ	FIND0
	MVI	A,IDEN
	JMP	STOKEN	;STORE TOKEN
FIND0:
	CALL	NUMERIC
	JZ	FIND1
	MVI	A,NUMB
	JMP	STOKEN
FIND1:
	LDA	NEXTC
	CPI	''''
	JNZ	FIND2
	XRA	A
	STA	NEXTC	;DON'T STORE THE QUOTE
	MVI	A,STRNG
	JMP	STOKEN
FIND2:	;ASSUME IT'S A SPECIAL CHARACTER
	CPI	LF	;IF LF THEN DUMP THE BUFFER
	JNZ	FIND3
;	LF FOUND
	LDA	L2EA3H
	ORA	A
	JZ	L1994H
	MVI	A,'+'
	STA	CBUFF+5
L1994H:
	CALL	S2595H
	LXI	H,CBUFF	;CLEAR ERROR CHAR ON BOTH PASSES
	MVI	M,' '
	MVI	A,16
	STA	CBP	;START NEW LINE
FIND3:
	MVI	A,SPECL
;
STOKEN:
	STA	TOKEN
;
;
;	LOOP WHILE CURRENT ITEM IS ACCUMULATING
SCTOK:
	LDA	NEXTC
	STA	LASTC	;SAVE LAST CHARACTER
	ORA	A
	CNZ	SAVER	;STORE CHARACTER INTO ACCUM IF NOT ZERO
	CALL	GNCN	;GET NEXT TO NEXTC
	LDA	TOKEN
	CPI	SPECL
	JNZ	L1A06H
	LDA	L305A
	ORA	A
	RNZ
;	CONVERT CONVENIENCE <,<=,=,<>,>=,> TO EQUIVALENTS
	LDA	ACCUM
	CPI	'='
	JNZ	LTLET	;NOT =
	LXI	H,'EQ'	;= TO EQ
	JMP	SAVERO
;
LTLET:	;TEST FOR < OR <=
	CPI	'<'
	JNZ	GTGET
	LXI	H,'LT'
	LDA	NEXTC
	CPI	'='
	JNZ	SAVERO
	LXI	H,'LE'
	JMP	SKIPN
;
GTGET:	;TEST FOR > OR >=
	CPI	'>'
	RNZ
	LXI	H,'GT'
	LDA	NEXTC
	CPI	'='
	JNZ	SAVERO
	LXI	H,'GE'
;
SKIPN:	;SKIP NEXTC
	XRA	A
	STA	NEXTC

;
SAVERO:	;SAVE H,L RELATIONAL OPERAND IN ACCUM
	SHLD	ACCUM
	LXI	H,ACCLEN
	INR	M	;ACCLEN=ACCLEN+1
	MVI	A,IDEN	;SET TOKEN TO IDEN
	STA	TOKEN
	RET
;
L1A06H:
	LXI	H,NEXTC
	LDA	TOKEN
	CPI	IDEN
	JNZ	SCT2
;
;	ACCUMULATING AN IDENTIFIER
	CALL	TDOLL
	JZ	SCTOK
	CALL	ALNUM
	JNZ	SCTOK
	RET
;
SCT2:
	CPI	NUMB
	JNZ	SECT3
	CALL	TDOLL
	JZ	SCTOK
	CALL	HEX
	JNZ	SCTOK
	LDA	NEXTC
	CPI	'O'
	JZ	NOCT
	CPI	'Q'
	JNZ	NUM2
;
NOCT:
	MVI	A,OCTV
	JMP	SSTYP
NUM2:
	CPI	'H'
	JNZ	NUM3
	MVI	A,HEXV
SSTYP:
	STA	STYPE
	XRA	A
	STA	NEXTC
	JMP	NCON
NUM3:
	LDA	LASTC
	CPI	'B'
	JNZ	NUM4
	MVI	A,BINV
	JMP	SSTY1
NUM4:
	CPI	'D'
	MVI	A,DECV
	JNZ	SSTY2
SSTY1:
	LXI	H,ACCLEN
	DCR	M
SSTY2:
	STA	STYPE
NCON:
	LXI	H,0
	SHLD	VALUE
	LXI	H,ACCLEN
	MOV	C,M
	INX	H
CLOP:
	MOV	A,M
	INX	H
	CPI	'A'
	JNC	CLOP1
	SUI	'0'
	JMP	CLOP2
CLOP1:
	SUI	'A'-10
CLOP2:
	PUSH	H
	PUSH	B
	MOV	C,A
	LXI	H,STYPE
	CMP	M
	CNC	SERRV
	MVI	B,0
	MOV	A,M
	LHLD	VALUE
	XCHG
	LXI	H,0
CLOP3:
	ORA	A
	JZ	CLOP4
	RAR
	JNC	TTWO
	DAD	D
TTWO:
	XCHG
	DAD	H
	XCHG
	JMP	CLOP3
CLOP4:
	DAD	B
	SHLD	VALUE
	POP	B
	POP	H
	DCR	C
	JNZ	CLOP
	RET	
SECT3:
	LDA	NEXTC
	CPI	CR
	JZ	SERRO
	CPI	''''
	JNZ	SCTOK
	CALL	GNCN
	CPI	''''
	RNZ
	JMP	SCTOK
;
WHTSPT:	;RETURN ZERO IF NULL, SPACE OR TAB WHITE SPACE
	LDA	NEXTC
	ORA	A
	RZ	
	CPI	' '
	RZ
	CPI	TAB
	RET
;
CSCSPT:	;RETURN ZERO IF COMMA, SEMI-COLON, OR PERCENT
	LDA	NEXTC
	CPI	','
	RZ	
	CPI	';'
	RZ	
	CPI	'%'
	RZ
;
EOLTC:	;END OF LINE TEST FOR COMMENT SCAN
	LDA	NEXTC
	CPI	CR
	RZ
	CPI	EOF
	RZ
	CPI	'!'
	RET	
;
SCSTCT:	;RETURN ZERO IF SEMI-COLON, SPACE, TAB OR COMMA
	LDA	NEXTC
	CPI	';'
	RZ
	CPI	' '
	RZ
	CPI	TAB
	RZ
	CPI	','
	RET
;
L1AFCH:
	CALL	ZERO
	XRA	A
	STA	TOKEN
	STA	BNL
;
SWHTSP:	;SKIP WHITESPACE
	CALL	WHTSPT
	JNZ	L1B12H
	CALL	GNCN
	JMP	SWHTSP
L1B12H:
	CALL	CSCSPT
	JNZ	L1B2FH
	MVI	A,SPECL
	STA	TOKEN
	JMP	L1BC9H
L1B20H:
	LDA	NEXTC
	STA	LASTC
	CALL	GNCN
	LDA	TOKEN
	CPI	SPECL
	RZ
;
L1B2FH:
	CALL	EOLTC
	JNZ	L1B47H
;	END OF LINE TESTS
	LDA	TOKEN
	CPI	STRNG
	CZ	SERRV	;SINGLE QUOTE ENCOUNTERED - 'V' ERROR
	LDA	BNL	;WITHIN A NESTED BRACKET?
	ORA	A	;
	CNZ	SERRV	;YES, 'V' ERROR
	JMP	L1BCFH
;
L1B47H:
	LDA	TOKEN
	CPI	STRNG
	JNZ	L1B6CH	;CURRENT TOKEN IS NOT A STRING
	LDA	NEXTC
	CPI	''''
	JNZ	L1BC9H
	CALL	SAVER
	CALL	GNCN
	LDA	NEXTC
	CPI	''''
	JZ	L1B20H
	XRA	A
	STA	TOKEN
	JMP	L1B2FH
;
L1B6CH:
	LDA	NEXTC
	CPI	''''
	JNZ	L1B7CH
	MVI	A,STRNG
	STA	TOKEN
	JMP	L1BC9H
L1B7CH:
	CPI	'^'
	JNZ	L1B97H
	CALL	GNCN
	LDA	NEXTC
	CPI	TAB
	JZ	L1BC9H
	CPI	' '
	JNC	L1BC9H
	CALL	SERRI
	JMP	L1BCFH
L1B97H:
	CPI	'<'	;LEFT BROKEN BRACKET?
	JNZ	L1BA8H	;NO
	LXI	H,BNL	;INCREMENT BRACKET LEVEL
	MOV	A,M
	INR	M
	ORA	A	;FIRST BRACKET?
	JZ	L1B20H	;YES, DO NOT STORE CHARACTER
	JMP	L1BC9H	;NO, STORE CHARACTER
L1BA8H:
	CPI	'>'
	JNZ	L1BBCH
	LXI	H,BNL
	MOV	A,M
	ORA	A
	JZ	L1BC9H
	DCR	M
	JZ	L1B20H
	JMP	L1BC9H
L1BBCH:
	LDA	BNL
	ORA	A
	JNZ	L1BC9H
	CALL	SCSTCT
	JZ	L1BCFH
L1BC9H:
	CALL	SAVER
	JMP	L1B20H
L1BCFH:
	MVI	A,TOKEN5
	STA	TOKEN
	RET	
;
;	END OF SCANNER
;
;	ERROR MESSAGE ROUTINES
SERRV:	;'V' SCAN VALUE ERROR
	PUSH	PSW
	MVI	A,'V'
	JMP	SERR
;
SERRO:	;'O' SCAN OVERFLOW ERROR
	PUSH	PSW
	MVI	A,'O'
	JMP	SERR
;
SERRI:	;'I' SCAN INVALID CHARACTER
	PUSH	PSW
	MVI	A,'I'
	JMP	SERR
;
SERRB:	;'B' SCAN BALANCE ERROR
	PUSH	PSW
	MVI	A,'B'
	JMP	SERR
;
SERR:	;SCAN PRINT ERROR MESSAGE
	PUSH	B
	PUSH	H
	CALL	PERR
	POP	H
	POP	B
	POP	PSW
	RET

ENDAS2M	EQU	($ AND 0FF00H) + 100H

;
; THESE DB ARE TO MAKE THE ORIGINAL MAC.COM MATCH BYTE FOR BYTE
; WHEN COMPARING THIS VERSION AND CAN BE REMOVED WHEN DONE
;
L1BF6H:	DB	0F1H,0C9H,000H,000H,000H,000H,000H,000H
L1BFEH:	DB	000H,000H

;;
;; AS3SYM
;;
	TITLE	'ASM SYMBOL TABLE MODULE'
;	SYMBOL TABLE MANIPULATION MODULE
;
	ORG 01C00H

L1C00H:
	JMP	02100H
INISYE:
	JMP	INISY
LOOKUPE:
	JMP	LOOKUP
FOUNDE:
	JMP	FOUND
ENTERE:
	JMP	ENTER
SETTYE:
	JMP	SETTY
GETTYE:
	JMP	GETTY
SETVALE:
	JMP	SETVAL
GETVALE:
	JMP	GETVAL
S1C1BH:
	JMP	L2059H
S1C1EH:
	JMP	L2060H
S1C21H:
	JMP	L2065H
S1C24H:
	JMP	L2092H
S1C27H:
	JMP	L20BCH
S1C2AH:
	JMP	L20B2H
S1C2DH:
	JMP	L1D7EH
S1C30H:
	JMP	L1DC5H
S1C33H:
	JMP	L1E8FH
S1C36H:
	JMP	L1E47H
S1C39H:
	JMP	L1F87H
S1C3CH:
	JMP	L1FA5H
S1C3FH:
	JMP	L1FBBH
S1C42H:
	JMP	L1FF0H
S1C45H:
	JMP	LCOMP
S1C48H:
	JMP	CHASH
S1C4BH:
	JMP	L1D66H
;
;
;       DATA AREAS
;       SYMBOL TABLE BEGINS AT THE END OF THIS MODULE
FIXD    EQU     5       ;5 BYTES OVERHEAD WITH EACH SYMBOL ENTRY
;                       2BY COLLISION, 1BY TYPE/LEN, 2BY VALUE
HTSIZE  EQU     128     ;HASH TABLE SIZE
HMASK   EQU     HTSIZE-1;HASH MASK FOR CODING
;HASHT:  DS	HTSIZE*2;HASH TABLE
;HASHC:  DS	1       ;HASH CODE AFTER CALL ON LOOKUP
;HASHP:	DS	2	;POINTER TO HASH ENTRY
;
; THESE DB ARE TO MAKE THE ORIGINAL MAC.COM MATCH BYTE FOR BYTE
; WHEN COMPARING THIS VERSION AND CAN BE REMOVED WHEN DONE
;
HASHT:	DB	044H,03FH,0B2H,03CH,01EH,03DH,0C7H,03DH
L1C56H:	DB	0A1H,03AH,000H,000H,065H,03EH,000H,000H
L1C5EH:	DB	03FH,03BH,020H,03EH,000H,000H,03CH,03EH
L1C66H:	DB	089H,03BH,020H,03CH,059H,03DH,032H,03DH
L1C6EH:	DB	003H,03EH,0E8H,03BH,0FAH,03CH,000H,000H
L1C76H:	DB	000H,000H,0B7H,03DH,000H,000H,052H,03EH
L1C7EH:	DB	0DCH,03EH,0E5H,03EH,000H,000H,000H,000H
L1C86H:	DB	046H,03EH,0DCH,03BH,000H,000H,09CH,03EH
L1C8EH:	DB	047H,03DH,000H,000H,000H,000H,000H,000H
L1C96H:	DB	000H,000H,093H,03DH,0C6H,03CH,015H,03DH
L1C9EH:	DB	000H,000H,0AEH,03DH,091H,03EH,0BEH,03DH
L1CA6H:	DB	000H,000H,000H,000H,000H,000H,000H,000H
L1CAEH:	DB	073H,03BH,0A5H,03DH,050H,03DH,000H,000H
L1CB6H:	DB	000H,000H,000H,000H,02AH,03EH,004H,03DH
L1CBEH:	DB	024H,03FH,050H,03AH,02DH,03FH,05DH,03EH
L1CC6H:	DB	02AH,03CH,015H,03CH,000H,000H,081H,03DH
L1CCEH:	DB	08AH,03DH,000H,000H,0E5H,03CH,0FFH,03BH
L1CD6H:	DB	000H,000H,09CH,03DH,081H,03EH,089H,03EH
L1CDEH:	DB	079H,03EH,00AH,03CH,055H,03CH,0FEH,03AH
L1CE6H:	DB	03FH,03CH,06BH,03CH,0DDH,03AH,0F4H,03BH
L1CEEH:	DB	000H,000H,000H,000H,000H,000H,0C6H,03EH
L1CF6H:	DB	000H,000H,000H,000H,000H,000H,009H,03BH
L1CFEH:	DB	0E8H,03AH,00DH,03DH,093H,03BH,0FBH,03EH
L1D06H:	DB	005H,03FH,000H,000H,000H,000H,0EEH,03EH
L1D0EH:	DB	050H,03FH,000H,000H,0AAH,03CH,0F9H,03DH
L1D16H:	DB	01AH,03FH,0B2H,03EH,0BCH,03EH,0EFH,03DH
L1D1EH:	DB	000H,000H,0DBH,03CH,0D1H,03CH,000H,000H
L1D26H:	DB	069H,03BH,000H,000H,000H,000H,000H,000H
L1D2EH:	DB	000H,000H,000H,000H,000H,000H,06DH,03DH
L1D36H:	DB	016H,03EH,000H,000H,000H,000H,063H,03DH
L1D3EH:	DB	0E5H,03DH,0A8H,03EH,06FH,03EH,076H,03CH
L1D46H:	DB	0DBH,03DH,0BCH,03CH,0A8H,03BH,038H,03FH
HASHC:	DB	001H
HASHP:	DB	04EH,01CH
;
;       SYMBOL TABLE ENTRY FORMAT IS
;               -----------------  OFFSET
;               : MSB VAL BYTE  :  5 + LENG
;               -----------------
;      VALADR=  : LSB VAL BYTE  :  4 + LENG
;               -----------------
;               : CHARACTER N   :  3 + LENG
;               -----------------
;               :    ...        :
;               -----------------
;               : CHARACTER 1   :  3
;               -----------------
;               : TYPE  : LENG  :  2
;               -----------------
;               : MSB COLLISION :  1
;               -----------------
;       SYADR=  : LSB COLLISION :  0
;               -----------------
;
;       VALADR=SYSADR+3+N
;
;       WHERE THE LOW/HIGH COLLISION FIELD ADDRESSES ANOTHER ENTRY WITH
;       THE SAME HASH CODE (OR ZERO IF THE END OF CHAIN), TYPE DESCRIBES
;       THE ENTRY TYPE (GIVEN BELOW), LENG IS THE NUMBER OF CHARACTERS IN
;       THE SYMBOL PRINTNAME -1 (I.E., LENG=0 IS A SINGLE CHARACTER PRINT-
;       NAME, WHILE LENG=15 INDICATES A 16 CHARACTER NAME).  CHARACTER 1
;       THROUGH N GIVE THE PRINTNAME CHARACTERS IN ASCII UPPER CASE (ALL
;       LOWER CASE NAMES ARE TRANSLATED ON INPUT), AND THE LOW/HIGH VALUE
;       GIVE THE PARTICULAR ADDRESS OR CONSTANT VALUE ASSOCIATED WITH THE
;       NAME.  THE REPRESENTATION OF MACROS DIFFERS IN THE FIELDS WHICH
;       FOLLOW THE VALUE FIELD (MACROS ARE NOT CURRENTLY IMPLEMENTED).
;
;       THE TYPE FIELD CONSISTS OF FOUR BITS WHICH ARE ASSIGNED AS
;       FOLLOWS:
;
;               0000    UNDEFINED SYMBOL
;               0001    LOCAL   LABELLED PROGRAM
;               0010    LOCAL   LABELLED DATA
;               0011    (UNUSED)
;               0100    EQUATE
;               0101    SET
;               0110    MACRO
;               0111    (UNUSED)
;
;               1000    (UNUSED)
;               1001    EXTERN  LABELLED PROGRAM
;               1010    EXTERN  LABELLED DATA
;               1011    REFERENCE TO MODULE
;               1100    (UNUSED)
;               1101    GLOBAL  UNDEFINED SYMBOL
;               1110    GLOBAL  LABELLED PROGRAM
;               1111    (UNUSED)
;
;       TYPE DEFINITIONS
;
UNDFT	EQU	0000B	;UNDEFINED
PLABT   EQU     0001B   ;PROGRAM LABEL
DLABT   EQU     0010B   ;DATA LABEL
EQUT    EQU     0100B   ;EQUATE
SETT    EQU     0101B   ;SET
MACT    EQU     0110B   ;MACRO
;
EXTT    EQU     1000B   ;EXTERNAL ATTRIBUTE
REFT    EQU     1011B   ;REFER
GLBT    EQU     1100B   ;GLOBAL ATTRIBUTE
;
;
INISY:	;INITIALIZE SYMBOL TABLE
	LXI	H,HASHT	;ZERO HASH TABLE
	MVI	B,HTSIZE
	XRA	A	;CLEAR ACCUM
INI0:
	MOV	M,A
	INX	H
	MOV	M,A	;CLEAR DOUBLE WORD
	INX	H
	DCR	B
	JNZ	INI0
;
;	SET SYMBOL TABLE POINTERS
	LXI	H,0
	SHLD	SYADR
;
	RET	

L1D66H:	;CLEAR RECORD BUFFER
	LXI	H,RBUFF
	MVI	B,RSIZE/2
	XRA	A
L1D6CH:
	MOV	M,A
	INX	H
	MOV	M,A	;CLEAR DOUBLE WORD
	INX	H
	DCR	B
	JNZ	L1D6CH
	RET	

	CALL	CHASH
	ANI	00FH
	STA	HASHC
	RET	

L1D7EH:
	LXI	H,L2EA3H
	MOV	A,M
	CPI	00FH
	JNC	L1E15H
	INR	M
	MOV	E,M	;INCREMENT MACRO NEST COUNT
	MVI	D,0
	LXI	H,L2EA4H
	MOV	A,M
	DAD	D
	MOV	M,A
	LXI	H,L2ED4H
	CALL	S1DBCH
	LXI	H,L2EB4H
	CALL	S1DBCH
	LXI	H,L2EF4H
	CALL	S1DBCH
	LXI	H,L2F14H
	MOV	A,M
	DAD	D
	MOV	M,A
	LXI	H,L2F24H
	CALL	S1DBCH
	LXI	H,L2F44H
	MOV	A,M
	DAD	D
	MOV	M,A
	LXI	H,L2F54H
	MOV	A,M
	DAD	D
	MOV	M,A
	RET	
S1DBCH:
	MOV	C,M
	INX	H
	MOV	B,M
	DAD	D
	DAD	D
	MOV	M,B
	DCX	H
	MOV	M,C
	RET	
L1DC5H:
	LXI	H,L2EA3H
	MOV	A,M
	ORA	A
	JZ	L1E15H
	PUSH	H
	MOV	E,M
	MVI	D,0
	LXI	H,L2EA4H
	CALL	S1E04H
	LXI	H,L2ED4H
	CALL	S1E0AH
	LXI	H,L2EB4H
	CALL	S1E0AH
	LXI	H,L2EF4H
	CALL	S1E0AH
	LXI	H,L2F14H
	CALL	S1E04H
	LXI	H,L2F24H
	CALL	S1E0AH
	LXI	H,L2F44H
	CALL	S1E04H
	LXI	H,L2F54H
	CALL	S1E04H
	POP	H
	DCR	M
	RET	
S1E04H:
	PUSH	H
	DAD	D
	MOV	A,M
	POP	H
	MOV	M,A
	RET
S1E0AH:
	PUSH	H
	DAD	D
	DAD	D
	MOV	C,M
	INX	H
	MOV	B,M
	POP	H
	MOV	M,C
	INX	H
	MOV	M,B
	RET
L1E15H:
	MVI	A,'B'
	JMP	PERR
;
CHASH:	;COMPUTE HASH CODE FOR CURRENT ACCUMULATOR
	LXI	H,ACCLEN
	SHLD	ACCLENP	;STORE POINTER TO ACCLEN
CHHL:	
	LHLD	ACCLENP	;H,L = ACCLEN
	MOV	B,M	;GET ACCUM LENGTH
	XRA	A	;CLEAR ACCUMULATOR
CH0:	INX	H	;MOVE TO FIRST/NEXT CHARACTER POSITION
	ADD	M	;ADD WITH OVERFLOW
	DCR	B
	JNZ	CH0
	ANI	HMASK	;MASK BITS FOR MODULO HSIZE
	STA	HASHC	;FILL HASHC WITH RESULT
	RET
;
SETLN:	;SET THE LENGTH FIELD OF THE CURRENT SYMBOL
	MOV	B,A
	LHLD	SYADR
	INX	H
	INX	H
	MOV	A,M
	ANI	0F0H
	ORA	B
	MOV	M,A
	RET
;
GETLN:	;GET THE LENGTH FIELD TO REG-A
	LHLD	SYADR
	INX	H
	INX	H
	MOV	A,M
	ANI	00FH
	INR	A	;LENGTH IS STORED AS VALUE-1
	RET	
;
L1E47H:
	CALL	FOUND
	RZ
	XCHG
	LXI	B,0
	LDA	L2EA4H
	CPI	1
	JZ	L1E74H
	LXI	H,L2EA3H
	MOV	C,M
	MVI	B,0
	LXI	H,L2EA4H
	DAD	B
;
L1E61H:
	MOV	A,C
	ORA	A
	JZ	L1E71H
	MOV	A,M
	CPI	001H
	JZ	L1E74H
	DCX	B
	DCX	H
	JMP	L1E61H

L1E71H:
	INR	A
	XCHG
	RET

L1E74H:
	LXI	H,L2F24H
	DAD	B
	DAD	B
	MOV	A,E
	SUB	M
	MOV	A,D
	INX	H
	SBB	M
	JC	FOUND
	LXI	H,0
	SHLD	SYADR
	XRA	A
	RET

FOUND:
	LHLD	SYADR
	MOV	A,L
	ORA	H
	RET
L1E8FH:
	LXI	H,L2F66H
	SHLD	ACCLENP
	CALL	CHHL
	LDA	HASHC
	ANI	00FH
	STA	HASHC
	LXI	H,RBUFF
	SHLD	HASHP
	JMP	L1EB8H
LOOKUP:
	CALL	CHASH
	LXI	H,HASHT
	SHLD	HASHP
	LXI	H,ACCLEN
	SHLD	ACCLENP
L1EB8H:
	LHLD	ACCLENP
	MOV	A,M
	CPI	17
	JC	LENOK
	MVI	M,16
LENOK:
	LXI	H,HASHC	;LOOK FOR SYMBOL THROUGH HASH TABLE
	MOV	E,M
	MVI	D,0	;DOUBLE HASH CODE IN D,E
	LHLD	HASHP	;HASHP = RBUFF
	DAD	D	;
	DAD	D	;HASHT(HASHC)
	MOV	E,M	;LOW ORDER ADDRESS
	INX	H	;
	MOV	H,M	;
	MOV	L,E	;HEADER TO LIST OF SYMBOLS IN H,L
LOOK0:
	SHLD	SYADR
	CALL	FOUND
	RZ		;RETURN IF SYADR BECOMES ZERO
;
;	OTHERWISE EXAMINE CHARACTER STRING FOR MATCH
	CALL	GETLN
	LHLD	ACCLENP
	CMP	M
	JNZ	LCOMP
	MOV	B,A
	INX	H
	XCHG
	LHLD	SYADR
	INX	H
	INX	H
	INX	H
LOOK1:
	LDAX	D
	CMP	M
	JNZ	LCOMP
	INX	D
	INX	H
	DCR	B
	JNZ	LOOK1
	RET
LCOMP:
	LHLD	SYADR
	MOV	E,M
	INX	H
	MOV	D,M
	XCHG
	JMP	LOOK0
;
;
ENTER:	;ENTER SYMBOL IN ACCUMULATOR
;	ENSURE THERE IS ENOUGH SPACE INN THE TABLE
	LXI	H,ACCLEN
	MOV	E,M
	MVI	D,0
	LHLD	SYTOP
	SHLD	SYADR
	DAD	D
	LXI	D,FIXD
	DAD	D
	XCHG
	LHLD	SYMAX
	MOV	A,E
	SUB	L
	MOV	A,D
	SBB	H
	XCHG	;NEW SYTOP IN H,L
	JNC	OVERER	;OVERFLOW IN TABLE
;
;	OTHERWISE NO ERROR
	SHLD	SYTOP	;SET NEW TABLE TOP
	LXI	H,HASHT
	SHLD	HASHP
	CALL	S1F31H
	XRA	A
	INX	H
	MOV	M,A
	INX	H
	MOV	M,A
	RET
S1F31H:
	LHLD	SYADR	;SYADR TO H,L
	XCHG		;SYADR TO D,E
	LXI	H,HASHC
	MOV	C,M
	MVI	B,0
	LHLD	HASHP
	DAD	B
	DAD	B
	MOV	C,M
	INX	H
	MOV	B,M
	MOV	M,D	;SAVE SYADR FOR HASH
	DCX	H
	MOV	M,E
	XCHG		;H,L=SYADR, D,E=HASHP
	MOV	M,C
	INX	H
	MOV	M,B
	LXI	D,ACCLEN
	LDAX	D
	CPI	011H
	JC	ENT1
	MVI	A,010H
ENT1:
	MOV	B,A
	DCR	A
	INX	H
	MOV	M,A

ENT2:
	INX	H
	INX	D
	LDAX	D
	MOV	M,A
	DCR	B
	JNZ	ENT2
	RET

S1F62H:
	LHLD	SYMAX
	XCHG
	LXI	H,ACCLEN
	MOV	L,M
	MVI	H,0
	DAD	B
	MOV	A,E
	SUB	L
	MOV	L,A
	MOV	A,D
	SBB	H
	MOV	H,A
	SHLD	SYADR
	XCHG
	LXI	H,SYTOP
	MOV	A,E
	SUB	M
	INX	H
	MOV	A,D
	SBB	M
	JC	OVERER
	XCHG
	SHLD	SYMAX
	RET
L1F87H:
	LXI	B,1
	CALL	S1F62H
	LHLD	SYMAX
	XCHG
	LXI	H,ACCLEN
	MOV	C,M
L1F95H:
	INX	H
	MOV	A,C
	ORA	A
	JZ	L1FA2H
	DCR	C
	MOV	A,M
	STAX	D
	INX	D
	JMP	L1F95H
L1FA2H:
	XRA	A
	STAX	D
	RET
L1FA5H:
	LXI	B,3
	CALL	S1F62H
	LXI	H,RBUFF
	SHLD	HASHP
	CALL	S1F31H
	LDA	HASHC
	CALL	SETTY
	RET
L1FBBH:
	LHLD	SYMAX
	XCHG
	LXI	H,L2F24H
	MOV	A,E
	SUB	M
	INX	H
	MOV	A,D
	SBB	M
	RNC 	
	XCHG	
	SHLD	SYADR
	CALL	GETTY
	MOV	E,A
	MVI	D,0
	LXI	H,RBUFF	;H,L = 2E83 BUFFER
	DAD	D
	DAD	D
	XCHG
	LHLD	SYADR
	MOV	A,M
	STAX	D
	INX	H
	MOV	A,M
	INX	D
	STAX	D
	CALL	VALADR
L1FE4H:
	MOV	A,M
	ORA	A
	INX	H
	JNZ	L1FE4H
	SHLD	SYMAX
	JMP	L1FBBH
L1FF0H:
	JMP	VALADR
OVERER:
	LXI	H,ERRSTO
	CALL	PCONE
	JMP	EOR
ERRSTO:
	DB	'SYMBOL TABLE OVERFLOW',CR
;
SETTY:	;SET TYPE IN REG-A FOR CURRENT SYMBOL IN SYSADR
	RAL		;MOVE TYPE TO UPPER 4 BITS
	RAL
	RAL
	RAL
	ANI	0F0H
	MOV	B,A
	LHLD	SYADR	;HIGH COLLISSION
	INX	H	;LOW COLLISION
	INX	H	;TYPE
	MOV	A,M	;GET CURRENT VALUE
	ANI	00FH	;RETAIN LENGTH
	ORA	B	;ADD TYPE
	MOV	M,A	;SAVE
	RET
;
GETTY:	;RETURN THE TYPE OF VALUE IN CURRENT SYMBOL IN SYSADR
	LHLD	SYADR
	INX	H
	INX	H
	MOV	A,M
	RAR
	RAR
	RAR
	RAR
	ANI	00FH
	RET	
;
VALADR:	;GET VALUE FIELD ADDRESS FOR CURRENT SYMBOL IN SYSADR
	CALL	GETLN	;PRINTNAME LENGTH TO REG-A
	LHLD	SYADR	;BASE ADDRESS
	MOV	E,A	;LENGTH TO REG-E
	MVI	D,0
	DAD	D	;BASE(LEN)
	INX	H
	INX	H	;FOR COLLISION FIELD
	INX	H	;FOR TYPE/LEN FIELD
	RET		;WITH H,L ADDRESSING VALUE FIELD
;
SETVAL:	;SET THE VALUE FIELD OF THE CURRENT SYMBOL TO H,L
;	VALUE IS SENT IN H,L
	PUSH	H	;SAVE VALUE TO SET
	CALL	VALADR	;VALUE ADDRESS IN H,L
	POP	D	;POP VALUE TO SET
	MOV	M,E	;SAVE LOW BYTE
	INX	H
	MOV	M,D	;SAVE HIGH BYTE
	RET
;
GETVAL:	;GET THE VALUE FIELD OF THE CURRENT SYMBOL AT H,L IN H,L
	CALL	VALADR	;ADDRESS OF VALUE FIELD TO H,L
	MOV	E,M
	INX	H
	MOV	D,M
	XCHG	
	RET

;
S2050H:
	CALL	VALADR
	INX	H
	INX	H
	SHLD	L3058
	RET	
;
L2059H:
	PUSH	PSW
	CALL	S2050H
	POP	PSW
	MOV	M,A
	RET	
;
L2060H:
	CALL	S2050H
	MOV	A,M
	RET	
L2065H:
	CALL	CHASH
	ANI	00FH
	ADD	A
	ADD	A
	ADD	A
	ADD	A
	MOV	C,A
	LXI	H,ACCLEN
	MOV	A,M
	CPI	011H
	JC	L207AH
	MVI	M,010H
L207AH:
	MOV	A,M
	DCR	A
	ORA	C
	CALL	L20BCH
	LXI	H,ACCLEN
	MOV	C,M
L2084H:
	INX	H
	MOV	A,M
	PUSH	B
	PUSH	H
	CALL	L20BCH
	POP	H
	POP	B
	DCR	C
	JNZ	L2084H
	RET
L2092H:
	CALL	L20B2H
	MOV	C,A
	RLC
	RLC
	RLC
	RLC
	ANI	00FH
	STA	HASHC
	MOV	A,C
	ANI	00FH
	INR	A
	MOV	C,A
	LXI	D,ACCLEN
	STAX	D
L20A8H:
	CALL	L20B2H
	INX	D
	STAX	D
	DCR	C
	JNZ	L20A8H
	RET	
L20B2H:
	LHLD	L3058
	INX	H
	SHLD	L3058
	MOV	A,M
	RET	
	RET	
L20BCH:
	MOV	C,A
	LHLD	L3058
	INX	H
	XCHG
	LHLD	SYMAX
	MOV	A,E
	SUB	L
	MOV	A,D
	SBB	H
	JNC	OVERER
	XCHG
	SHLD	L3058
	MOV	M,C
	INX	H
	SHLD	SYTOP
	RET	

ACCLENP:
	DB	0EBH
	DB	022H,0FEH,02CH
	DB	0C2H,052H,016H
	DB	022H,0E2H,011H
	DB	0C3H,052H,016H
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0DAH,096H,007H
	DB	00DH
	DB	0CAH,096H,007H
	DB	0C3H,080H,007H
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0
	DB	0

ENDAS3M	EQU	($ AND 0FF00H) + 100H

;;
;;
;; AS4SEAR.ASM
;;
;;
	TITLE	'ASM TABLE SEARCH MODULE'

	ORG 02100H

L2100H:
	JMP	02600H
BSEARE:
	JMP	BSEAR
BGETE:
	JMP	BGET
S2109H:
	JMP	L2462H
S210CH:
	JMP	L247BH
ELINX:
	DB	0FCH

;
;       TABLE DEFINITIONS
;
;       TYPES
;
;       O1 THROUGH O15 DENOTE OPERATIONS
RT      EQU     25
PT      EQU     RT+1    ;RT IS REGISTER TYPE, PT IS PSEUDO OPERATION
OBASE   EQU     PT+1
O1      EQU     OBASE+1 ;SIMPLE
O2      EQU     OBASE+2 ;LXI
O3      EQU     OBASE+3 ;DAD
O4      EQU     OBASE+4 ;PUSH/POP
O5      EQU     OBASE+5 ;JMP/CALL
O6      EQU     OBASE+6 ;MOV
O7      EQU     OBASE+7 ;MVI
O8      EQU     OBASE+8 ;ACC IMMEDIATE
O9      EQU     OBASE+9 ;LDAX/STAX
O10     EQU     OBASE+10        ;LHLD/SHLD/LDA/STA
O11     EQU     OBASE+11        ;ACCUM REGISTER
O12     EQU     OBASE+12        ;INC/DEC
O13     EQU     OBASE+13        ;INX/DCX
O14     EQU     OBASE+14        ;RST
O15     EQU     OBASE+15        ;IN/OUT
;
;       X1 THROUGH X24 DENOTE OPERATORS
XBASE   EQU     0       ;START OF OPERATORS
X1      EQU     XBASE   ;*   0  00
X2      EQU     XBASE+1 ;/   1  01
X3      EQU     XBASE+2 ;MOD 2  02
X4      EQU     XBASE+3 ;SHL 3  03
X5      EQU     XBASE+4 ;SHR 4  04
X6      EQU     XBASE+5 ;+   5  05
X7      EQU     XBASE+6 ;-   6  06
X8      EQU     XBASE+7 ;UNARY - 7  07
X9      EQU     XBASE+8 ;EQ  8  08
X10     EQU     XBASE+9 ;LT  9  09
X11     EQU     XBASE+10;LE  10 0A
X12     EQU     XBASE+11;GT  11 0B
X13     EQU     XBASE+12;GE  12 0C
X14     EQU     XBASE+13;NE  13 0D
X15     EQU     XBASE+14;NOT 14 0E
X16     EQU     XBASE+15;AND 15 0F
X17     EQU     XBASE+16;OR  16 10
X18     EQU     XBASE+17;XOR 17 11
X19     EQU     XBASE+18;HIGH  18 12
X20     EQU     XBASE+19;LOW 19 13
X21     EQU     XBASE+20;(   20 14
X22     EQU     XBASE+21;)   21 15
X23     EQU     XBASE+22;,   22 16
X24     EQU     XBASE+23;CR  23 17
X25     EQU     XBASE+24;NUL 24 18

OPER	EQU	X25	;LAST OPERATOR

PLUS	EQU	X6	;PLUS OPERATOR
MINUS	EQU	X7	;MINUS OPERATOR
NOTF	EQU	X15	;NOT OPERATOR
HIGHF	EQU	X19	;HIGH OPERATOR
LOWF	EQU	X20	;LOW OPERATOR
LPAR	EQU	X21	;LEFT PARANTHESIS OPERATOR
RPAR	EQU	X22	;RIGHT PARANTHESIS OPERATOR
NULF	EQU	X25	;NUL OPERAND
;
;
;
;
;       RESERVED WORD TABLES
;

CINX:
	DW	CHAR1
	DW	CHAR2
	DW	CHAR3
	DW	CHAR4
	DW	CHAR5
	DW	CHAR6
	DW	CLEN
;
CMAX    EQU     ($-CINX)/2-1    ;LARGEST STRING TO MATCH
;
TVINX:
	DW	TV1
	DW	TV2
	DW	TV3
	DW	TV4
	DW	TV5
	DW	TV6

CHAR1:
	DB	CR
	DB	'()'
	DB	'*+,'
	DB	'-'
	DB	'/'
	DB	'ABCDEHLM'
CHAR2:
	DB	'DB'
	DB	'DI'
	DB	'DS'
	DB	'DW'
	DB	'EI'
	DB	'EQ'
	DB	'GE'
	DB	'GT'
	DB	'IF'
	DB	'IN'
	DB	'LE'
	DB	'LT'
	DB	'NE'
	DB	'OR'
	DB	'SP'
CHAR3:
	DB	'ACI'
	DB	'ADC'
	DB	'ADD'
	DB	'ADI'
	DB	'ANA'
	DB	'AND'
	DB	'ANI'
	DB	'CMA'
	DB	'CMC'
	DB	'CMP'
	DB	'CPI'
	DB	'DAA'
	DB	'DAD'
	DB	'DCR'
	DB	'DCX'
	DB	'END'
	DB	'EQU'
	DB	'HLT'
	DB	'INR'
	DB	'INX'
	DB	'IRP'
	DB	'JMP'
	DB	'LDA'
	DB	'LOW'
	DB	'LXI'
	DB	'MOD'
	DB	'MOV'
	DB	'MVI'
	DB	'NOP'
	DB	'NOT'
	DB	'NUL'
	DB	'ORA'
	DB	'ORG'
	DB	'ORI'
	DB	'OUT'
	DB	'POP'
	DB	'PSW'
	DB	'RAL'
	DB	'RAR'
	DB	'RET'
	DB	'RLC'
	DB	'RRC'
	DB	'RST'
	DB	'SBB'
	DB	'SBI'
	DB	'SET'
	DB	'SHL'
	DB	'SHR'
	DB	'STA'
	DB	'STC'
	DB	'SUB'
	DB	'SUI'
	DB	'XOR'
	DB	'XRA'
	DB	'XRI'
CHAR4:
	DB	'ASEG'
	DB	'CALL'
	DB	'CSEG'
	DB	'DSEG'
	DB	'ELSE'
	DB	'ENDM'
	DB	'HIGH'
	DB	'IRPC'
	DB	'LDAX'
	DB	'LHLD'
	DB	'NAME'
	DB	'PAGE'
	DB	'PCHL'
	DB	'PUSH'
	DB	'REPT'
	DB	'SHLD'
	DB	'SPHL'
	DB	'STAX'
	DB	'XCHG'
	DB	'XTHL'
CHAR5:
	DB	'ENDIF'
	DB	'EXITM'
	DB	'EXTRN'
	DB	'LOCAL'
	DB	'MACRO'
	DB	'STKLN'
	DB	'TITLE'
CHAR6:
	DB	'INPAGE'
	DB	'MACLIB'
	DB	'PUBLIC'

CHAR7:	;END OF CHARACTER VECTOR

CLEN:	;LENGTH VECTOR GIVES THE NUMBER OF ITEMS IN EACH TABLE
	DB	(CHAR2-CHAR1)
	DB	(CHAR3-CHAR2)/2
	DB	(CHAR4-CHAR3)/3
	DB	(CHAR5-CHAR4)/4
	DB	(CHAR6-CHAR5)/5 
	DB	(CHAR7-CHAR6)/6

TV1:	;TYPE,VALUE PAIRS FOR CHAR1 VECTOR
	DB	X24,0AH,	X21,014H	;CR (
	DB	X22,01EH,	X1,050H		;) *
	DB	X6,046H,	X23,00AH	;+ ,
	DB	X7,046H,	X2,050H		;- /
	DB	RT,007H,	RT,000H		;A B
	DB	RT,001H,	RT,002H		;C D
	DB	RT,003H,	RT,004H		;E H
	DB	RT,005H,	RT,006H		;L M
TV2:	;TYPE,VALUE PAIRS FOR CHAR2 VECTOR
	DB	PT,001H,	O1,0F3H		;DB DI
	DB	PT,002H,	PT,003H		;DS DW
	DB	O1,0FBH,	X9,041H		;EI EQ
	DB	X13,041H,	X12,041H	;GE GT
	DB	PT,008H,	02AH,0DBH	;IF IN
	DB	X11,041H,	X10,041H	;LE LT
	DB	X14,041H,	X17,028H	;NE OR
	DB	RT,006H				;SP
TV3:	;TYPE,VALUE PAIRS FOR CHAR3 VECTOR
	DB	023H,0CEH,	026H,088H	;ACI ADC
	DB	026H,080H,	023H,0C6H	;ADD ADI
	DB	026H,0A0H,	00FH,032H	;ANA AND
	DB	023H,0E6H,	01CH,02FH	;ANI CMA
	DB	01CH,03FH,	026H,0B8H	;CMC CMP
	DB	023H,0FEH,	01CH,027H	;CPI DAA
	DB	01EH,009H,	027H,005H	;DAD DCR
	DB	028H,00BH,	PT,004H		;DCX END
	DB	PT,007H,	01CH,076H	;EQU HLT
	DB	027H,004H,	028H,003H	;INR INX
	DB	PT,00EH,	020H,0C3H	;IRP JMP
	DB	025H,03AH,	013H,01EH	;LDA LOW
	DB	01DH,001H,	002H,050H	;LXI MOD
	DB	021H,040H,	022H,006H	;MOV MVI
	DB	01CH,000H,	00EH,03CH	;NOP NOT
	DB	018H,000H,	026H,0B0H	;NUL ORA
	DB	PT,00AH,	023H,0F6H	;ORG ORI
	DB	02AH,0D3H,	01FH,0C1H	;OUT POP
	DB	RT,006H,	01CH,017H	;PSW RAL
	DB	01CH,01FH,	01CH,0C9H	;RAR RET
	DB	01CH,007H,	01CH,00FH	;RLC RRC
	DB	029H,0C7H,	026H,098H	;RST SBB
	DB	023H,0DEH,	PT,00BH		;SBI SET
	DB	003H,050H,	004H,050H	;SHL SHR
	DB	025H,032H,	01CH,037H	;STA STC
	DB	026H,090H,	023H,0D6H	;SUB SUI
	DB	011H,028H,	026H,0A8H	;XOR XRA
	DB	023H,0EEH			;XRI
TV4:	;;TYPE,VALUE PAIRS FOR CHAR4 VECTOR
	DB	PT,00DH,	020H,0CDH	;ASEG CALL   SHOULD BE PT,011H??
	DB	PT,012H,	PT,013H		;CSEG DSEG
	DB	PT,00DH,	PT,006H		;ELSE ENDM
	DB	012H,01EH,	PT,00FH		;HIGH IRPC
	DB	024H,00AH,	025H,02AH	;LDAX LHLD
	DB	PT,014H,	PT,015H		;NAME PAGE
	DB	01CH,0E9H,	01FH,0C5H	;PCHL PUSH
	DB	PT,010H,	025H,022H	;REPT SHLD
	DB	01CH,0F9H,	024H,002H	;SPHL STAX
	DB	01CH,0EBH,	01CH,0E3H	;XCHG XTHL
TV5:	;TYPE,VALUE PAIRS FOR CHAR5 VECTOR
	DB	PT,005H,	PT,016H		;ENDIF EXITM
	DB	PT,017H,	PT,018H		;EXTRN LOCAL
	DB	PT,009H,	PT,01CH		;MACRO STKLN
	DB	PT,00CH				;TITLE
TV6:	;TYPE,VALUE PAIRS FOR CHAR6 VECTOR
	DB	PT,019H,	PT,01AH		;INPAGE MACLIB
	DB	PT,01BH				;PUBLIC

SUFTAB:
	DB	'NZZ NCC POPEP M '
;
BSEAR:	;BINARY SEARCH MNEMONIC TABLE
;	INPUT: UR = UPPER BOUND OF TABLE (I.E., TABLE LENGTH-1)
;	SR = SIZE OF EACH TABLE ELEMENT
;	H,L ADDRESS BASE OF TABLE TO SEARCH
;	OUTPUT: ZERO FLAG INDICATES MATCH WAS FOUND, IN WHICH CASE
;	THE ACCUMULATOR CONTAINS AN INDEX TO THE ELEMENT
;	NOT ZERO FLAG INDICATES NO MATCH FOUND IN TABLE
;

UR	EQU	B	;UPPER BOUND REGISTER
LR	EQU	C	;LOWER BOUND REGISTER
SR	EQU	D	;SIZE REGISTER
MR	EQU	E	;MIDDLE POINTER REGISTER
SP1	EQU	B	;SIZE PRIME, USED IN COMPUTING MIDDLE POSITON
SP1P	EQU	C	;ANOTHER COPY OF SIZE PRIME
KR	EQU	H	;K
;

	MVI	MR,255	;MARK M <> OLD M
	INR	UR	;U=U+1
	MVI	LR,0	;L = 0
;
;	COMPUTE M' = (U+L)/2
NEXT:
	XRA	A
	MOV	A,UR	;CY=0, A=U
	ADD	LR	;(U+L)
	RAR		;(U+L)/2
	CMP	MR	;SAME AS LAST TIME THROUGH?
	JZ	NMATCH	;JUMP IF = TO NO MATCH
;
;	MORE ELEMENTS TO SCAN
	MOV	MR,A	;NEW MIDDLE VALUE
	PUSH	H	;SAVE A COPY OF THE BASE ADDRESS
	PUSH	D	;SAVE S,M
	PUSH	B	;SAVE U,L
	PUSH	H	;SAVE ANOTHER COPY OF THE BASE ADDRESS
	MOV	SP1,SR	;S' = S
	MOV	SP1P,SP1;S'' = S1
	MVI	SR,0	;FOR DOUBLE PRECISION OPERATION BELOW (DOUBLE M)
	LXI	KR,0	;K=0
SUMK:
	DAD	D	;K = K + M
	DCR	SP1	;S' = S' - 1
	JNZ	SUMK	;DECREMENT IF SP1 <> 0
;
;	K IS NOW RELATIVE TO BYTE POSITION
	POP	D	;TABLE BASE ADDRESS
	DAD	D	;H,L CONTAINS ABS ADDRESS OF BYTE TO COMP
	LXI	D,ACCUM	;D,E ADDRESS CHARACTERS TO COMPARE
;
COMK:	;COMPARE NEXT CHARACTER
	LDAX	D	;ACCUM CHAR TO REG A
	CMP	M	;SAME AS TABLE ENTRY?
	INX	D
	INX	H	;TO NEXT POSITIONS
	JNZ	NOCOM	;JUMP IF NOT THE SAME
	DCR	SP1P	;MORE CHARACTERS?
	JNZ	COMK
;
;	COMPLETE MATCH AT M
	POP	B
	POP	D	;M RESTORED
	POP	H
	MOV	A,MR	;VALUE OF M COPIED IN A
	RET		;WITH ZERO FLAG SET
;
NOCOM:
	POP	B	;U,L
	POP	D	;S,M
	POP	H	;TABLE ADDRESS
	JC	NCOML
;	ACCUM IS HIGHER
	MOV	LR,MR	;L = M
	JMP	NEXT
;
NCOML:	;ACCUMULATOR IS LOW
	MOV	UR,MR	;U = M
	JMP	NEXT
;
NMATCH:	;NO MATCH
	XRA	A
	INR	A	;SETS NOT ZERO FLAG
	RET
;
PREFIX:	;J C OR R PREFIX?
	LDA	ACCUM
	LXI	B,0C220H;JNZ OPCODE TO B, TYPE TO C
	CPI	'J'
	RZ		;RETURN WITH ZERO FLAG SET IF J
	MVI	B,0C4H	;CNZ OPCODE TO B, TYPE IS IN C
	CPI	'C'
	RZ
	LXI	B,0C01CH;RNZ OPCODE
	CPI	'R'
	RET
;
SUFFIX:	;J R OR C RECOGNIZED, LOOK FOR SUFFIX
	LDA	ACCLEN
	CPI	004H	;CHECK LENGTH
	JNC	NSUFF	;CARRY IF 0,1,2,3 IN LENGTH
	CPI	003H
	JZ	SUF0	;ASSUME 1 OR 2 IF NO BRANCH
	CPI	002H
	JNZ	NSUFF	;RETURNS IF 0 OR 1

	LXI	H,ACCUM+2
	MVI	M,' '	;BLANK-OUT FOR MATCH ATTEMPT
SUF0:	;SEARCH 'TIL END OF TABLE
	LXI	B,8	;B=0, C=8 COUNTS TABLE DOWN TO ZERO OR MATCH
	LXI	D,SUFTAB
NEXTS:	;LOOK AT NEXT SUFFIX
	LXI	H,ACCUM+1	;SUFFIX POSITION
	LDAX	D		;CHARACTER TO ACCUM
	CMP	M
	INX	D		;READY FOR NEXT CHARACTER
	JNZ	NEXT0		;JMP IF NO MATCH
	LDAX	D		;GET NEXT CHARACTER
	INX	H		;READY FOR COMPARE WITH ACCUM
	CMP	M		;SAME?
	RZ			;RETURN WITH ZERO FLAG SET, B IS SUFFIX
NEXT0:	INX	D		;MOVE TO NEXT CHARACTER
	INR	B		;COUNT SUFFIX UP
	DCR	C		;COUNT TABLE LENGTH DOWN
	JNZ	NEXTS
;	END OF TABLE, MARK WITH NON ZERO FLAG
	INR	C
	RET
;
NSUFF:	;NOT PROPER SUFFIX - SET NON ZERO FLAG
	XRA	A
	INR	A
	RET
;
BGET:   ;PERFORM BINARY SEARCH, AND EXTRACT TYPE AND VAL FIELDS	FOR
;       THE ITEM.  ZERO FLAG INDICATES MATCH WAS FOUND, WITH TYPE
;       IN THE ACCUMULATOR, AND VAL IN REGISTER B.  THE SEARCH IS BASED
;       UPON THE LENGTH OF THE ACCUMULATOR
	LDA	ACCLEN	;ITEM LENGTH
	MOV	C,A	;SAVE A COPY
	DCR	A	;ACCLEN-1
	MOV	E,A
	MVI	D,0	;DOUBLE ACCLEN-1 TO D,E
	PUSH	D	;SAVE A COPY FOR LATER
	CPI	CMAX	;TOO LONG?
	JNC	NGET	;NOT IN RANGE IF CARRY
	LXI	H,CLEN	;LENGTH VECTOR
	DAD	D
	MOV	UR,M	;FILL UPPER BOUND FROM MEMORY
	LXI	H,CINX
	DAD	D
	DAD	D	;BASE ADDRESS TO H,L
	MOV	D,M
	INX	H
	MOV	H,M
	MOV	L,D	;NOW IN H,L
	MOV	SR,C	;FILL THE SIZE REGISTER
	CALL	BSEAR	;PERFORM THE BINARY SEARCH
	JNZ	SCASE	;ZERO IF FOUND
	STA	ELINX	;ELEMENT INDEX
	POP	D	;RESTORE INDEX
	LXI	H,TVINX
	DAD	D
	DAD	D	;ADDRESSING PROPER TV ELEMENT
	MOV	E,M
	INX	H
	MOV	D,M
;       D,E IS BASE ADDRESS OF TYPE/VALUE VECTOR, ADD	DISPLACEMENT
	MOV	L,A
	MVI	H,000H
	DAD	H	;DOUBLED
	DAD	D	;INDEXED
	XRA	A
	MOV	C,A
	MOV	A,M	;TYPE TO ACC
	INX	H
	MOV	B,M	;VALUE TO B
	RET		;TYPE IN ACC, VALUE IN B
;
SCASE:	;NAME NOT TOO LONG, BUT NOT FOUND IN TABLES, MAY BE J C OR R
	POP	D	;RESTORE INDEX
	CALL	PREFIX
	RNZ		;NOT FOUND AS PREFIX J C OR R IF NOT ZERO
	PUSH	B	;SAVE VALUE AND TYPE
	CALL	SUFFIX	;ZERO IF SUFFIX MATCHED
	MOV	A,B	;READY FOR MASK IF ZERO FLAG
	POP	B	;RECALL VALUE AND TYPE
	RNZ		;RETURN IF NOT ZERO FLAG SET
	ORA	A	;CLEAR CARRY
	RAL
	RAL
	RAL
	ORA	B	;VALUE SET TO JNZ ...
	MOV	B,A	;REPLACE
	MOV	A,C	;RETURN WITH TYPE IN REGISTER A
	CMP	A	;CLEAR THE ZERO FLAG
	MVI	C,001H
	RET
;
NGET:	;CAN'T FIND THE ENTRY, RETURN WITH ZERO FLAG RESET
	POP	D	;GET THE ELEMENT BACK
	XRA	A	;CLEAR
	INR	A	;ZERO FLAG RESET
	RET

L2462H:
	LXI	H,ACCLEN
	MOV	C,M
	DCR	C
	LXI	H,CLEN+1
	XRA	A
L246BH:
	DCR	C
	JZ	L2474H
	ADD	M
	INX	H
	JMP	L246BH
;
L2474H:
	LXI	H,ELINX
	ADD	M
	ORI	080H
	RET
;
L247BH:
	ANI	07FH
	LXI	H,L2499H
	MOV	E,A
	MVI	D,0
	DAD	D
	DAD	D
	MOV	E,M
	INX	H
	MOV	A,M
	RAR
	RAR
	RAR
	RAR
	ANI	00FH
	MOV	B,A
	MOV	A,M
	ANI	00FH
	MOV	D,A
	LXI	H,CHAR2
	DAD	D
	MOV	A,B
	RET	

L2499H:
	NOP
	DW	00220H
	DW	00420H
	DW	00620H
	DW	00820H
	DW	00A20H
	DW	00C20H
	DW	00E20H
	DW	01020H
	DW	01220H
	DW	01420H
	DW	01620H
	DW	01820H
	DW	01A20H
	DW	01C20H
	DW	01E20H
	DW	02130H
	DW	02430H
	DW	02730H
	DW	02A30H
	DW	02D30H
	DW	03030H
	DW	03330H
	DW	03630H
	DW	03930H
	DW	03C30H
	DW	03F30H
	DW	04230H
	DW	04530H
	DW	04830H
	DW	04B30H
	DW	04E30H
	DW	05130H
	DW	05430H
	DW	05730H
	DW	05A30H
	DW	05D30H
	DW	06030H
	DW	06330H
	DW	06630H
	DW	06930H
	DW	06C30H
	DW	06F30H
	DW	07230H
	DW	07530H
	DW	07830H
	DW	07B30H
	DW	07E30H
	DW	08130H
	DW	08430H
	DW	08730H
	DW	08A30H
	DW	08D30H
	DW	09030H
	DW	09330H
	DW	09630H
	DW	09930H
	DW	09C30H
	DW	09F30H
	DW	0A230H
	DW	0A530H
	DW	0A830H
	DW	0AB30H
	DW	0AE30H
	DW	0B130H
	DW	0B430H
	DW	0B730H
	DW	0BA30H
	DW	0BD30H
	DW	0C030H
	DW	0C330H
	DB	040H
	DB	0C7H
	DB	040H
	DB	0CBH,040H
	RST 1	;252B	CF 	. 
	MOV	B,B	;252C	40 	@ 
	DB	0D3H	;252D	D3 	. 
	MOV	B,B	;252E	40 	@ 
	RST 2	;252F	D7 	. 
	MOV	B,B	;2530	40 	@ 
	IN 040H	;2531	DB	40 	. @ 
	RST 3	;2533	DF 	. 
	MOV	B,B	;2534	40 	@ 
	XTHL	;2535	E3 	. 
	MOV	B,B	;2536	40 	@ 
	RST 4	;2537	E7 	. 
	MOV	B,B	;2538	40 	@ 
	XCHG	;2539	EB 	. 
	MOV	B,B	;253A	40 	@ 
	RST 5	;253B	EF 	. 
	MOV	B,B	;253C	40 	@ 
	DI	;253D	F3 	. 
	MOV	B,B	;253E	40 	@ 
	RST 6	;253F	F7 	. 
	MOV	B,B	;2540	40 	@ 
	EI	;2541	FB 	. 
	MOV	B,B	;2542	40 	@ 
	RST 7	;2543	FF 	. 
	MOV	B,B	;2544	40 	@ 
	INX	B	;2545	03 	. 
	MOV	B,C	;2546	41 	A 
	RLC	;2547	07 	. 
	MOV	B,C	;2548	41 	A 
	DB	00BH	;2549	0B 	. 
	MOV	B,C	;254A	41 	A 
	RRC	;254B	0F 	. 
	MOV	B,C	;254C	41 	A 
	INX	D	;254D	13 	. 
	MOV	D,C	;254E	51 	Q 
	DW	05118H	;254F	18 51 	. Q 
	DCR	E	;2551	1D 	. 
	MOV	D,C	;2552	51 	Q 
	SHLD	02751H	;2553	22 51 27 	" Q ' 
	MOV	D,C	;2556	51 	Q 
	INR	L	;2557	2C 	, 
	MOV	D,C	;2558	51 	Q 
	LXI	SP,03651H	;2559	31 51 36 	1 Q 6 
	MOV	H,C	;255C	61 	A 
	INR	A	;255D	3C 	< 
	MOV	H,C	;255E	61 	A 
	MOV	B,D	;255F	42 	B 
	MOV	H,C	;2560	61 	A 
	MOV	E,B	;2561	58 	X 
	DW	02230H	;2562	30 22 	0 " 
	CMP	L	;2564	BD 	. 
	LXI	D,SMAC3	;2565	11 CD 06 	. . . 
	MVI	D,0C3H	;2568	16 C3 	. . 
	MOV	D,A	;256A	57 	W 
	RLC	;256B	07 	. 
	MOV	A,D	;256C	7A 	Z 
	MOV	A,E	;256D	7B 	{ 
	MOV	A,H	;256E	7C 	| 
	MOV	A,L	;256F	7D 	} 
	XRA	A	;2570	AF 	. 
	MOV	C,A	;2571	4F 	O 
	MOV	A,M	;2572	7E 	~ 
	INX	H	;2573	23 	# 
	MOV	B,M	;2574	46 	F 
	RET		;2575	C9 	. 
	MOV	A,C	;2576	79 	Y 
	MVI	C,001H	;2577	0E 01 	. . 
	CMP	A	;2579	BF 	. 
	RET		;257A	C9 	. 

;
; THESE DB ARE TO MAKE THE ORIGINAL MAC.COM MATCH BYTE FOR BYTE
; WHEN COMPARING THIS VERSION AND CAN BE REMOVED WHEN DONE
;
L257BH:	DB	053H,045H,041H,052H,020H

ENDAS4M	EQU	$

;;
;; AS1IO
;;
	TITLE	'ASM IO MODULE'
;	I/O MODULE FOR CP/M ASSEMBLER
;
	ORG	2580H

INITIO:
	JMP	INIT
S2583H:
	JMP	SETUP
S2586H:
	JMP	GNC
	JMP	PNC
	JMP	PNB
	JMP	PCHAR
PCONE:
	JMP	PCON
S2595H:
	JMP	L2B74H
PERR:
	JMP	L2C21H
DHEXE:
	JMP	DHEX
EOR:
	JMP	L2C8BH
S25A1H:
	JMP	L2C49H
OMACLBE:
	JMP	OMACLB
S25A7H:
	JMP	L26E1H
S25AAH:
	JMP	L2B4DH
S25ADH:
	JMP	L2AF9H
PAGEN:	DB	080H	;PAGE NUMBER STRING
	DB	0
	DB	0
LINES:	DB	0	;LINES PER PAGE
LINEC:	DB	0	;LINE COUNT
PARM1:
	DB	0
BPC:
	DW	0
DBL:
	DB	0
DBUFF:
;	DB	0,0,0,0,0,0,0,0
;	DB	0,0,0,0,0,0,0,0
;
; THESE DB ARE TO MAKE THE ORIGINAL MAC.COM MATCH BYTE FOR BYTE
; WHEN COMPARING THIS VERSION AND CAN BE REMOVED WHEN DONE
;
	DB	000H,000H,000H,000H,019H,000H,000H,000H
	DB	037H,00EH,01AH,0C3H,005H,000H,011H,080H

;	DISK NAMES
CDISK:	DB	0	;CURRENTLY SELECTED DISK
ADISK:	DS	1	;.ASM DISK	25CA
PDISK:	DS	1	;.PRN DISK	25CB
SDISK	DS	1	;.SYM DISK	25CC
HDISK:	DS	1	;.HEX DISK	25CD
LDISK:	DS	1	;.LIB DISK	25CE
	DS	1

MBC:	DW	0	;MACRO BUFFER COUNTER

PCNT:
	DS	1
;
;	FILE CONTROL BLOCKS, BUFFERS AND POINTERS
SCB:
	DS	1
	DS	8
	DB	'ASM'
SCBR:	DB	0
	DS	19
SCBCR:	DS	1

SBP:	DW	SSIZE	;NEXT CHARACTER POSITION TO READ
SBUFF:	DS	2

PCB:
	DS	1	;
	DS	8	;PCB FILENAME
PCBT:
	DB	'PRN',0
	DS	19
PCBR:
	DB	0

PBP:	DS	2
PBUFF:	DS	2

HCB:
	DS	1
	DS	8
	DB	'HEX',0
	DS	19
	DB	0

HBP:	DW	0
HBUFF:	DS	2

SDMA:
	MVI	C,SETDM
	JMP	BDOS
;
SETBF:	;SET DMA TO BUFF
	LXI	D,BUFF
	JMP	SDMA
;
SEL:
	LXI	H,CDISK
	CMP	M
	RZ
	MOV	M,A
	MOV	E,A
	MVI	C,SELECT
	CALL	BDOS
	RET
SELA:
	LDA	ADISK
	JMP	SEL
SELP:
	LDA	PDISK
	JMP	SEL
SELS:
	LDA	SDISK
	JMP	SEL
SELH:
	LDA	HDISK
	JMP	SEL
SELL:
	LDA	LDISK
	JMP	SEL
PCON:
	MOV	A,M
	CALL	PCHAR
	MOV	A,M
	INX	H
	CPI	CR
	JNZ	PCON
	MVI	A,LF
	CALL	PCHAR
	RET
FNAME:	;FILL NAME FROM DEFAULT FILE CONTROL BLOCK
	LXI	D,FCB
	MVI	B,FNML+1
FNAM0:
	LDAX	D
	CPI	'?'
	JZ	FNERR
	CPI	'$'
	JZ	FNERR
	MOV	M,A
	INX	H
	INX	D
	DCR	B
	JNZ	FNAM0
	RET

;
OMACLB:	;OPEN MACLIB FILE
	LXI	H,FCB	;H,L = FCB
	MVI	M,0	;CURRENT DRIVE
	LXI	D,ACCLEN
	LDAX	D	;A = ACCUM LENGTH
	CPI	9	;LESS THAN 9 CHARACTERS?
	JC	OMAC0
	MVI	A,8	;FORCE TO 8 CHARACTERS
OMAC0:
	MOV	B,A	;LENGTH IN B
	MOV	C,A	;LENGTH IN C
OMAC1:
	INX	D	;D=ACCUM
	INX	H	;H=FCB.FILENAME
	LDAX	D	;GET BYTE FROM ACCUM
	MOV	M,A	;STORE IN FCB.FILENAME
	DCR	C	;MORE BYTES?
	JNZ	OMAC1

	MVI	A,8
	SUB	B
	MOV	C,A
	INR	C	;REMAINING BYTES IN C
;
OMAC2:	;FILL REMAING FILENAME WITH SPACES
	INX	H	;NEXT FILENAME CHARACTER
	DCR	C	;MORE BYTES?
	JZ	OMAC3
	MVI	M,' '
	JMP	OMAC2
;
OMAC3:	;SET FCB FILE TYPE TO 'LIB'
	MVI	M,'L'
	INX	H
	MVI	M,'I'
	INX	H
	MVI	M,'B'
	INX	H
	XRA	A
	MOV	M,A	;ZERO EXTENT
	STA	0007CH	;AND FCB CURRENT RECORD
	CALL	SELL
	LXI	D,FCB
	JMP	OPEN	;OPEN AND RETURN

L26E1H:
	MVI	A,TRUE
	STA	MLFLG
	LXI	H,BSIZE
	SHLD	MBC
	LXI	H,NEXTC
	MOV	A,M
	STA	HDISK+2
	XRA	A
	MOV	M,A
	RET

INIT:
	CALL	SETBF
	LXI	H,TITL
	CALL	PCON
	MVI	A,038H
	STA	LINES
	XRA	A
	STA	LINEC
	LXI	H,00000H
	SHLD	L3062
	LHLD	FBASE
	SHLD	SYMAX
	LXI	H,03100H
	SHLD	SBUFF
	LXI	D,SSIZE
	DAD	D
	SHLD	PBUFF
	LXI	D,PSIZE
	DAD	D
	SHLD	HBUFF
	LXI	D,HSIZE
	DAD	D
	INX	H
	SHLD	SYTOP
	SHLD	SYBASE
	JMP	INITP	;INITIALIZE DEFAULT PARAMETERS

;
WNSP:	;WRITE NO SPACE
	CPI	' '
	RZ
	PUSH	B
	PUSH	H
	MOV	E,A
	MVI	C,WRITC
	CALL	BDOS
	POP	H
	POP	B
	RET

L2744H:
	INX	H
	MOV	A,M
	CALL	WNSP
	DCR	C
	JNZ	L2744H
	RET

;
S274EH:
	PUSH	H
	XCHG	
	LDA	CDISK
	ADI	'A'	;DRIVE LETTER A-Z
	CALL	WNSP
	MVI	A,':'
	CALL	WNSP
	MVI	C,008H
	CALL	L2744H
	MVI	A,'.'
	CALL	WNSP
	MVI	C,003H
	CALL	L2744H
	MVI	A,'-'
	CALL	WNSP
	POP	H
	JMP	PCON

OPEN:
	MVI	C,OPENF
	PUSH	D
	CALL	BDOS
	CPI	0FFH
	POP	D
	RNZ
	LXI	H,ERROP
	CALL	S274EH
	JMP	BOOT

CLOSE:
	MVI	C,CLOSF
	PUSH	D
	CALL	BDOS
	CPI	0FFH
	POP	D
	RNZ
	LXI	H,ERRCL
	CALL	PCON
	JMP	BOOT
;
DELETE:
	MVI	C,DELEF
	JMP	BDOS
;
MAKE:
	MVI	C,MAKEF
	PUSH	D
	CALL	BDOS
	CPI	0FFH
	POP	D
	RNZ
	LXI	H,ERRMA
	CALL	S274EH
	JMP	BOOT
;
NPR:	;RETURN 0 FLAG IF NO PRINT FILE
	LDA	PDISK
	CPI	'Z'-'A'	;Z - NULL FILE?
	RZ
	CPI	'X'-'A'	;X - CONSOLE?
	RZ
	CPI	'P'-'A'	;P - LINE PRINTER?
	RET

S27BFH:
	CPI	TAB	;IF NOT TAB
	JNZ	L27D2H	;PRINT CHARACTER

L27C4H:
	MVI	A,' '	;CONVERT TAB TO SPACES
	CALL	L27D2H
	LDA	PCNT
	ANI	007H
	JNZ	L27C4H
	RET	

L27D2H:
	PUSH	PSW
	MOV	E,A
	MVI	C,WRITP
	CALL	BDOS
	POP	PSW
	LXI	H,PCNT
	CPI	00AH
	JNZ	L27E5H
	MVI	M,0
	RET	

L27E5H:
	CPI	020H
	RC	
	INR	M
	RET	
;
INITP:	;INITIALIZE DEFAULT ASSEMBLY PARAMETERS AND DRIVE SELECT
	XRA	A
	STA	PCNT
	STA	MLFLG
	STA	PARML
	STA	PARMQ
	STA	PARMR
	STA	PARM1
	LDA	FCB
	CPI	' '
	JZ	FNERR

	MVI	C,CSEL
	CALL	BDOS
	LXI	H,CDISK
	MOV	M,A
	INX	H
	MOV	M,A
	INX	H
	MOV	M,A
	INX	H
	MOV	M,A
	INX	H
	MOV	M,A
	INX	H
	MOV	M,A
	INX	H
	MVI	A,1
	STA	PARMS
	STA	PARMM
	LDA	FCB+17	;FCB2 FILENAME
	CPI	'$'	;PARAMETERS INDICATED WITH A $
	JNZ	ISPFCB	;NO PARAMETERS
	LXI	H,BUFF+1;DEFAULT BUFFER AREA
;
L282CH:	;SEARCH BUFF FOR START OF PARAMETER INDICATOR
	MOV	A,M
	INX	H
	CPI	'$'
	JNZ	L282CH
;
PPLOOP:	;PROCESS PARAMETER LOOP
	MOV	A,M
	ORA	A
	JZ	ISPFCB	;JUMP IF BYTE IS 00H
	INX	H	;MOVE H,L TO NEXT BYTE
	CPI	' '
	JZ	PPLOOP	;SKIP SPACES
	LXI	D,ADISK
	CPI	'A'	;.ASM SOURCE DRIVE
	JZ	SETDSK
	INX	D
	CPI	'P'	;.PRN DESTINATION DRIVE
	JZ	SETDSK
	INX	D
	CPI	'S'	;.SYM DESTINATION DRIVE
	JZ	SETDSK
	INX	D
	CPI	'H'	;.HEX DESTINATION DRIVE
	JZ	SETDSK
	INX	D
	CPI	'L'	;.LIB SOURCE DRIVE
	JZ	SETDSK
	INX	D
	MVI	B,7
	CPI	'*'
	JZ	L2874H
	MVI	B,3
	CPI	'+'
	JZ	L2874H
	MVI	B,0
	CPI	'-'
	JNZ	PARERR
;
L2874H:
	LXI	D,PARMS
	MOV	A,M	;H,L IS BYTE AFTER *, + OR -
	CPI	'S'	;+S OR -S
	JZ	SETPAR
	INX	D	;PARAMD
	CPI	'M'
	JZ	SETPAR	;+M OR -M
	LXI	D,PARML
	CPI	'L'	;+L OR -L
	JZ	SETPAR
	LXI	D,PARMQ
	CPI	'Q'	;+Q OR -Q
	JZ	SETPAR
	LXI	D,PARMR
	CPI	'R'	;+R OR -R ???
	JZ	SETPAR
	LXI	D,PARM1
	CPI	'1'	;+1 OR -1
	JNZ	PARERR	;INVALID PARAMETER
;
SETPAR:	;SET PARAMETER
	MOV	A,B
	STAX	D
	INX	H
	JMP	PPLOOP
;
SETDSK:	;STORE DRIVE NUMBER FOR DISK POINTED TO BY D,E
	MOV	A,M
	SUI	'A'	;A=0,B=1,...
	CPI	26	;MAX DRIVE IS 26 (Z)
	JNC	PARERR	;ERROR
	STAX	D	;SAVE DRIVE NUMBER
	INX	H
	JMP	PPLOOP
;
PARERR:	;INVALID PARAMETER
	INX	H
	MVI	M,CR
	LXI	H,ERRPA
	CALL	PCON
	LXI	H,BUFF+1;PARAMETER STRING
	CALL	PCON
	JMP	BOOT	;EXIT BACK TO CP/M
;
ISPFCB:	;INITIALIZE SOURCE AND PRINT FCBS
	LXI	H,SCB
	CALL	FNAME
	LXI	H,PCB
	PUSH	H
	CALL	FNAME
	POP	H
	CALL	NPR
	JZ	NOPR
	PUSH	H
	PUSH	H
	CALL	SELP
	POP	D
	CALL	DELETE
	POP	D
	CALL	MAKE
;
NOPR:	;
	LDA	HDISK
	CPI	019H
	JZ	L2904H
	LXI	H,HCB
	PUSH	H
	PUSH	H
	CALL	FNAME
	CALL	SELH
	POP	D
	CALL	DELETE
	POP	D
	CALL	MAKE
L2904H:
	RET	

SETUP:	;SETUP INPUT FILE FOR SOURCE PROGRAM
	LXI	H,PAGEN
	MVI	M,'0'
	INX	H
	MVI	M,'0'
	INX	H
	MVI	M,'0'
	INX	H
	MVI	A,0FFH
	STA	L3066
	LXI	H,0
	SHLD	PBP
	LDA	PASS
	ORA	A
	CNZ	L2AF9H
	LXI	H,SSIZE
	SHLD	SBP
	XRA	A
	STA	SCBR
	STA	SCBCR
	STA	DBL
	CALL	SELA
	LXI	D,SCB
	CALL	OPEN
;
	RET
;
FNERR:	;FILE NAME ERROR
	LXI	H,ERRFN
	CALL	PCON
	JMP	BOOT
;
;
GCOMP:	;COMPARE D,E AGAINST H,L
	MOV	A,D
	CMP	H
	RNZ
	MOV	A,E
	CMP	L
	RET
;
GNC:	;GET NEXT CHARACTER FROM SOURCE BUFFER OR MACRO BUFFER
	PUSH	B
	PUSH	D
	PUSH	H
	LDA	MLFLG
	ORA	A
	JZ	L29A2H

	LHLD	MBC	;MACRO BUFFER COUNT
	LXI	D,BSIZE	;COMPARE TO BUFFER SIZE
	CALL	GCOMP	;
	JNZ	L2977H	;JUMP IF MORE BYTES TO GO

	LXI	H,0	;RESET BUFFER COUNT
	SHLD	MBC	;
	CALL	SELL	;SELECT LIBRARY DRIVE
	MVI	C,READF	;READ ANOTHER BUFFER
	LXI	D,FCB	;
	CALL	BDOS	;
	ORA	A	;
	JNZ	L2989H	;ERROR?
L2977H:
	LHLD	MBC
	INX	H
	SHLD	MBC
	DCX	H
	LXI	D,BUFF
	DAD	D
	MOV	A,M
	CPI	EOF
	JNZ	GNC4	;JUMP IF NOT END OF FILE
;
L2989H:	;END OF MACLIB FILE
	LDA	L2EA3H
	ORA	A
	STA	MLFLG	;RESET MLFLG
	JZ	L29A2H
	CALL	SELL
	LXI	D,FCB
	LXI	H,ERRUM
	CALL	S274EH
	JMP	BOOT
L29A2H:
	LHLD	SBP
	LXI	D,SSIZE
	CALL	GCOMP
	JNZ	GNC3
;
;	READ ANOTHER BUFFER
	CALL	SELA
	LXI	H,0
	SHLD	SBP
	MVI	B,NSB	;NUMBER OF SOURCE BUFFERS
	LHLD	SBUFF
GNC0:	;READ 128 BYTES
	PUSH	B	;SAVE BUFFER jjCOUNT
	PUSH	H	;SAVE BUFFER ADDRESS
	XCHG
	CALL	SDMA	;SET READ BUFFER ADDRESS
	MVI	C,READF
	LXI	D,SCB
	CALL	BDOS	;PERFORM THE READ
	POP	H	;RESTORE SBUFF ADDRESS
	LXI	D,128	;NEXT BUFFER
	DAD	D	;H,L+=128
	POP	B	;RESTORE COUNT
	ORA	A	;NON ZERO BDOS RETURN VALUE?
	JNZ	GNC1
;	NORMAL READ OCCURRED
	DCR	B
	JNZ	GNC0
	JMP	GNC2
GNC1:
	CPI	3	;ALLOW 0,1,2
	JNC	FRERR	;FILE READ ERROR
	DCR	B	;LAST BUFFER?
	JZ	GNC2
	MVI	C,128
GNCE:
	MVI	M,EOF	;STORE END OF FILE CHARACTER
	INX	H
	DCR	C
	JNZ	GNCE	;FILL CURRENT BUFFER WITH EOF'S
GNC2:
	CALL	SETBF

GNC3:
	LHLD	SBUFF
	XCHG
	LHLD	SBP
	PUSH	H	;SAVE CURRENT SBP
	INX	H	;READY FOR NEXT READ
	SHLD	SBP
	POP	H	;RESTORE PREVIOUS SBP
	DAD	D	;ABSOLUTE ADDRESS OF CHARACTER
	MOV	A,M	;GET IT
GNC4:
	POP	H
	POP	D
	POP	B
	ANI	07FH	;STRIP HIGH BIT
	RET
FRERR:
	LXI	H,ERRFR
	CALL	PCON
	JMP	BOOT
;
PNC:	;SAME AT PNCF, BUT ENVIRONMENT IS SAVED FIRST
	PUSH	B
;       CHECK FOR CONSOLE OUTPUT / NO OUTPUT
	MOV	B,A	;SAVE CHARACTER
	LDA	PDISK	;Z OR X?
	CPI	'Z'-'A'
	JZ	PNRET
	CPI	'X'-'A'
	JNZ	PNG0
	MOV	A,B	;RECOVER CHARACTER FOR CON OUT
	CALL	PCHAR
	JMP	PNRET
;
;       NOT X OR Z, SO PRINT IT
PNG0:	PUSH	D
	PUSH	H
	CPI	'P'-'A'	;LINE PRINTER?
	MOV	A,B
	JNZ	L2A32H
	CALL	S27BFH
	JMP	L2A35H
L2A32H:
	CALL	PNCF
L2A35H:
	POP	H
	POP	D
PNRET:
	POP	B
	RET	
;
PNCF:	;PRINT NEXT CHARACTER
	LHLD	PBP
	XCHG	
	LHLD	PBUFF
	DAD	D
	MOV	M,A
	XCHG	
	INX	H
	SHLD	PBP
	XCHG	
	LXI	H,PSIZE
	CALL	GCOMP
	RNZ	
	CALL	SELP
	LXI	H,0
	SHLD	PBP
	LHLD	PBUFF
	LXI	D,PCB
	MVI	B,NPB
WBUFF:
	MOV	A,M
	CPI	EOF
	JZ	L2A85H	;DO NOT PRINT
	PUSH	B
	PUSH	D
	PUSH	H
	XCHG	
	CALL	SDMA
	POP	H
	LXI	D,BUFF
	DAD	D
	POP	D
	PUSH	D
	PUSH	H
	MVI	C,WRITF
	CALL	BDOS
	POP	H
	POP	D
	POP	B
	ORA	A
	JNZ	FWERR
	DCR	B
	JNZ	WBUFF

L2A85H:
	CALL	SETBF	;SET DMA TO BUFF
	RET	

	JMP	WBUFF
FWERR:
	LXI	H,ERRFW
	CALL	PCON
	JMP	EORPC
PNB:
	PUSH	B
	PUSH	D
	PUSH	H
	CALL	PNBF
	POP	H
	POP	D
	POP	B
S2A9EH:
	RET	

PNBF:
	LHLD	HBP
	XCHG	
	LHLD	HBUFF
	DAD	D
	MOV	M,A
	XCHG	
	INX	H
	SHLD	HBP
	XCHG	
	LXI	H,HSIZE
	CALL	GCOMP
	RNZ	
	CALL	SELH
	LXI	H,0
	SHLD	HBP
	LHLD	HBUFF
	LXI	D,HCB
	MVI	B,NHB
	JMP	WBUFF
;
PCHAR:	;PRINT CHARACTER IN REGISTER A
	PUSH	B
	PUSH	D
	PUSH	H
	MVI	C,WRITC
	MOV	E,A
	CALL	BDOS
	POP	H
	POP	D
	POP	B
	RET	
;
S2AD6H:	;INCREMENT PAGE NUMBER
	LXI	H,PAGEN+2
	MVI	C,3	;ADD 3
L2ADBH:
	MOV	A,M	;GET DIGIT
	INR	A	;INCREMENT BY 1
	MOV	M,A	;STORE DIGIT
	CPI	'9'+1
	JC	L2AEAH	;IF '0'-'9' PRINT DIGITS
	MVI	M,'0'	;SET TO '0'
	DCX	H
	DCR	C
	JNZ	L2ADBH	;INCREMENT NEXT DIGIT
;
L2AEAH:	;PRINT PAGE NUMBER
	LXI	H,PAGEN
	MVI	C,3
;
L2AEFH:	;PRINT STRING AT H,L LENGTH IN C
	MOV	A,M
	CALL	PNC
	INX	H
	DCR	C
	JNZ	L2AEFH
	RET	
;
L2AF9H:
	LDA	LINES
	ORA	A
	RZ	
	MVI	A,FF
	CALL	PNC
	XRA	A
	STA	LINEC
	LHLD	L3062
	MOV	A,L
	ORA	H
	RZ	
	LXI	H,TITL
L2B10H:
	MOV	A,M
	CPI	CR
	JZ	L2B1DH
	CALL	PNC
	INX	H
	JMP	L2B10H
L2B1DH:
	MVI	A,TAB
	CALL	PNC
	MVI	A,'#'
	CALL	PNC
	CALL	S2AD6H
	MVI	A,TAB
	CALL	PNC
	LHLD	L3062
L2B32H:
	MOV	A,M
	ORA	A
	JZ	L2B3EH
	CALL	PNC
	INX	H
	JMP	L2B32H
L2B3EH:
	MVI	A,CR
	CALL	PNC
	MVI	A,LF
	CALL	PNC
	MVI	A,LF
	JMP	PNC
L2B4DH:
	MOV	A,L
	STA	LINES
	LXI	H,LINEC
	SUB	M
	RNC 	
	JMP	L2AF9H
;
WOCHAR:	;WRITE CHARACTER IN REG-A WITH REFLECT AT CONSOLE IF ERROR
	MOV	C,A	;SAVE THE CHAR
	CALL	PNC	;PRINT THE CHAR
	LDA	CBUFF
	CPI	' '
	RZ	
	LDA	PASS
	CPI	2
	RZ	
	LDA	PDISK
	CPI	017H
	RZ	
	MOV	A,C
	CALL	PCHAR
	RET	

L2B74H:
	LDA	PARM1
	LXI	H,PASS
	ORA	M
	JNZ	L2B95H
	LDA	PARML	;SOURCE DISK FOR .LIB FILES
	LXI	H,MLFLG
	ANA	M
	JNZ	L2BE3H
	MOV	A,M
	ORA	A
	JZ	L2C10H
	LDA	CBUFF
	CPI	' '
	JZ	L2C10H
L2B95H:
	LXI	H,CBUFF
	MOV	A,M
	CPI	' '
	JNZ	L2BE3H
	LDA	L3066
	ORA	A
	JZ	L2C10H
	LDA	CBUFF+5
	CPI	'+'
	JNZ	L2BE3H
	LDA	PARMM
	ORA	A
	JZ	L2C10H
	CPI	3
	JZ	L2BE3H
	LDA	CBUFF+6
	CPI	'#'
	JZ	L2C10H
	LDA	CBUFF+1
	CPI	' '
	JZ	L2C10H
	LDA	PARMM
	DCR	A
	JZ	L2BE3H
	LXI	D,00010H
L2BD3H:
	DCX	D
	LXI	H,CBUFF
	DAD	D
	MOV	A,M
	CPI	' '
	JZ	L2BD3H
	INX	D
	LXI	H,CBP
	MOV	M,E
L2BE3H:
	LXI	H,LINEC
	PUSH	H
	MOV	A,M
	LXI	H,LINES
	SUB	M
	CNC	L2AF9H
	POP	H
	INR	M
	LDA	CBP
	LXI	H,CBUFF
L2BF7H:
	ORA	A
	JZ	L2C06H
	MOV	B,A
	MOV	A,M
	CALL	WOCHAR
	INX	H
	MOV	A,B
	DCR	A
	JMP	L2BF7H
;
L2C06H:	;SEND CR LF
	MVI	A,CR
	CALL	WOCHAR
	MVI	A,LF
	CALL	WOCHAR
;
L2C10H:	;CLEAR CBUFF
	XRA	A
	STA	CBP
	LXI	H,CBUFF
	MVI	A,CBMAX
L2C19H:
	MVI	M,' '
	INX	H
	DCR	A
	JNZ	L2C19H
	RET	

L2C21H:
	MOV	B,A
	LXI	H,CBUFF
	MOV	A,M
	CPI	' '
	RNZ
	MOV	M,B
	RET	
L2C2BH:
	CALL	NPR
	RZ
L2C2FH:
	LHLD	PBP
	MOV	A,L
	ORA	H
	JZ	L2C3FH
	MVI	A,EOF
	CALL	PNC
	JMP	L2C2FH
L2C3FH:
	CALL	SELP
	LXI	D,PCB
	CALL	CLOSE
	RET	
L2C49H:
	LDA	PARMS
	CPI	003H
	JZ	L2AF9H
	CALL	L2C2BH
	LXI	H,PCBT
	MVI	M,'S'
	INX	H
	MVI	M,'Y'
	INX	H
	MVI	M,'M'
	INX	H
	XRA	A
	MOV	M,A
	LXI	H,PCBR
	MOV	M,A
	LDA	SDISK
	STA	PDISK
	LXI	H,0
	SHLD	PBP
	CALL	NPR
	JZ	L2AF9H
	XRA	A
	STA	LINES
	CALL	SELP
	LXI	D,PCB
	PUSH	D
	CALL	DELETE
	POP	D
	CALL	MAKE
	RET	
L2C8BH:
	CALL	L2C2BH
	LDA	HDISK
	CPI	019H
	JZ	EORPC
	LDA	DBL
	ORA	A
	CNZ	WHEX
	LHLD	FPC
	SHLD	BPC
	CALL	WHEX
EOR1:
	LHLD	HBP
	MOV	A,L
	ORA	H
	JZ	EORPC
	MVI	A,EOF
	CALL	PNB
	JMP	EOR1
EORPC:
	NOP	
	NOP	
	NOP	
	LDA	HDISK
	CPI	'Z'-'A'
	JZ	EORHC
	CALL	SELH
	LXI	D,HCB
	CALL	CLOSE
EORHC:
	LXI	H,ENDA
	CALL	PCON
	JMP	BOOT
TITL:
	DB	'CP/M MACRO ASSEM 2.0',CR
ERROP:
	DB	'NO SOURCE FILE PRESENT',CR
ERRMA:
	DB	'NO DIRECTORY SPACE',CR
ERRFN:
        DB	'SOURCE FILE NAME ERROR',CR
ERRPA:
	DB	'INVALID PARAMETER:',CR
ERRFR:
	DB	'SOURCE FILE READ ERROR',CR
ERRFW:
	DB	'OUTPUT FILE WRITE ERROR',CR
ERRCL:
	DB	'CANNOT CLOSE FILES',CR
ERRUM:
	DB	'UNBALANCED MACRO LIB',CR
ENDA:
	DB	'END OF ASSEMBLY',CR
;
DHEX:	;DATA TO HEX BUFFER (BYTE IN REG-A)
	PUSH	B
	MOV	B,A	;HOLD CHARACTER FOR Z TEST
	LDA	HDISK
	CPI	'Z'-'A'
	MOV	A,B	;RECOVER CHARACTER
	JZ	DHRET
	PUSH	D	;ENVIRONMENT SAVED
	PUSH	PSW	;SAVE DATA BYTE
	LXI	H,DBL	;CURRENT LENGTH
	MOV	A,M	;TO A
	ORA	A	;ZERO?
	JZ	DHEX3
;
;LENGTH NOT ZERO, MAY BE FULL BUFFER
	CPI	16
	JC	DHEX1	;BR IF LESS THAN 16 BYTES
;BUFFER FULL, DUMP IT
	CALL	WHEX	;DBL = 0 UPON RETURN
	JMP	DHEX3	;SET BPC AND DATA BYTE
;
DHEX1:	;PARTIAL BUFFER IN PROGRESS, CHECK FOR SEQUENTIAL BYTE LOAD
	LHLD	FPC
	XCHG	
	LHLD	BPC	;BASE PC IN H,L
	MOV	C,A	;CURRENT BUFFER LENGTH
	MVI	B,0	;IS IN B,C
	DAD	B	;BPC+DBL TO H,L
	MOV	A,E	;READY FOR COMPARE
	CMP	L	;EQUAL?
	JNZ	DHEX2	;BR IF NOT
	MOV	A,D	;CHECK HIGH ORDER BYTE
	CMP	H
	JZ	DHEX4	;BR IF SAME ADDRESS
;
DHEX2:	;NON SEQUENTIAL ADDRESS, DUMP AND CHANGE BASE ADDRESS
	CALL	WHEX
DHEX3:	;SET NEW BASE
	LHLD	FPC
	SHLD	BPC
;
DHEX4:	;STORE DATA BYTE AND INC DBL
	LXI	H,DBL
	MOV	E,M	;LENGTH TO REG-E
	INR	M	;DBL=DBL+1
	MVI	D,0	;HIGH ORDER ZERO FOR DOUBLE ADD
	LXI	H,DBUFF
	DAD	D	;DBUFF+DBL TO H,L
	POP	PSW	;RESTORE DATA BYTE
	MOV	M,A	;INTO DATA BUFFER
	POP	D
DHRET:	POP	B	;ENVIRONMENT RESTORED
	RET	
;
WRC:	;WRITE CHARACTER WITH CHECKSUM IN D
	PUSH	PSW
	RRC	
	RRC	
	RRC	
	RRC	
	ANI	00FH
	CALL	HEXC	;OUTPUT HEX CHARACTER
	POP	PSW	;RESTORE BYTE
	PUSH	PSW	;SAVE A VERSION
	ANI	00FH
	CALL	HEXC	;WRITE LOW NIBBLE
	POP	PSW	;RESTORE BYTE
	ADD	D	;COMPUTE CHECKSUM
	MOV	D,A	;SAVE CHECKSUM
	RET
;
HEXC:	;WRITE CHARACTER
	ADI	090H
	DAA	
	ACI	040H
	DAA	
	JMP	PNB	;PUT BYTE
;
WHEX:	;WRITE CURRENT HEX BUFFER
	MVI	A,':'	;RECORD HEADER
	CALL	PNB	;PUT BYTE
	LXI	H,DBL	;RECORD LENGTH ADDRESS
	MOV	E,M	;LENGTH TO REG-E
	XRA	A	;ZERO TO REG-A
	MOV	D,A	;CLEAR CHECKSUM
	MOV	M,A	;LENGTH IS ZEROED FOR NEXT WRITE
	LHLD	BPC	;BASE ADDRESS FOR RECORD
	MOV	A,E	;LENGTH TO A
	CALL	WRC	;WRITE HEX VALUE
	MOV	A,H	;HIGH ORDER BASE ADDRESS
	CALL	WRC	;WRITE HO BYTE
	MOV	A,L	;LOW ORDER BASE ADDRESS
	CALL	WRC	;WRITE LO BYTE
	XRA	A	;ZERO TO A
	CALL	WRC	;WRITE RECORD TYPE 00
	MOV	A,E	;CHECK FOR LENGTH 0
	ORA	A
	JZ	WHEX1
;
;	NON - ZERO, WRITE DATA BYTES
	LXI	H,DBUFF
WHEX0:
	MOV	A,M	;GET BYTE
	INX	H
	CALL	WRC	;WRITE DATA BYTE
	DCR	E	;END OF BUFFER?
	JNZ	WHEX0
;
WHEX1:	;END OF DATA BYTES, WRITE CHECKSUM
	XRA	A
	SUB	D	;COMPUTE CHECKSUM
	CALL	WRC
;
;	SEND CRLF AT END OF RECORD
	MVI	A,CR
	CALL	PNB
	MVI	A,LF
	CALL	PNB
	RET

;;
;;
;;
	ORG	2E83H

RSIZE	EQU	32
RBUFF:	DS	RSIZE	;2EA2	FF 	. 
L2EA3H:
	DS	1	;2EA3	FF 	. 
L2EA4H:
	DS	1	;2EA4	FF 	. 
L2EA5H:
	DS	1	;2EA5	FF 	. 
L2EA6H:
	DS	1	;2EA6	FF 	. 
L2EA7H:
	DS	1	;2EA7	FF 	. 
L2EA8H:
	DS	2	;2EA8	FF 	. 
L2EAAH:
	DS	2	;2EAA	FF 	. 
L2EACH:
	DS	8	;2EAC	FF 	. 
L2EB4H:
	DS	32	;2EB4	FF 	. 
L2ED4H:
	DS	32	;2ED4	FF 	. 
L2EF4H:
	DS	32
L2F14H:
	DS	16
L2F24H:
	DS	32
L2F44H:
	DS	16
L2F54H:
	DS	16
L2F64H:
	DS	1
L2F65H:
	DS	1
L2F66H:
	DS	1
L2F67H:
	DS	1
L2F68H:
	DS	36
;	DS	152	;2EF4

CBMAX:  EQU     120     ;CONSOLE OUTPUT BUFFER SIZE
CBUFF:	DS	CBMAX	;CONSOLE OUTPUT BUFFER

ENDAS1M	EQU	($ AND 0FF00H) + 100H

	ORG	3000H

	DS	2
	DS	2
CBP:	DB	1	;CBUFF INDEX

;
;	SCANNER PARAMETERS
TOKEN:	DS	1	;CURRENT TOKEN EQU	03005H
VALUE:	DS	2	;BINARY VALUE FOR NUMBERS	EQU	03006H
ACCLEN:	DS	1	;ACCUMULATOR LENGTH	EQU	03008H
ACMAX	EQU	64	;LENGTH OF ACCUMULATOR
ACCUM:	DS	ACMAX	;ACCUMULATOR (MUST FOLLOW ACCLEN)	EQU	03009H
;
;	OPERAND EXPRESSION EVALUATOR PARAMETERS
EVALUE:	DS	2	;VALUE OF EXPRESSION AFTER EVALUATION	EQU	ACCUM+ACMAX
;
;	SYMBOL TABLE MODULE PARAMETERS
SYTOP:	DW	ENDMAC	;FIRST LOCATION AVAILABLE FOR SYMBOL TABLE
SYMAX:	DS	2	;LAST AVAILABLE LOCATION FOR SYMBOL TABLE
;
;	MISCELLANEOUS DATA AREAS
PASS:	DS	1	;PASS # 0,1	EQU	0304FH
FPC:	DS	2	;FILL ADDRESS FOR NEXT HEX RECORD
ASPC:	DS	2	;ASSEMBLER'S PSEUDO PC
SYBASE:	DW	ENDMAC	;SYMBOL TABLE BASE
SYADR:	DS	2	;CURRENT SYMBOL BASE
L3058:	DS	2	;NEW SYMBOL TABLE
L305A:	DS	1	;305A
NEXTC:	DS	1	;305B
L305C:	DS	1	;INLINE MACRO TYPE
MLFLG:	DS	1	;MACLIB FLAG
PARMS:	DS	1	;305E
PARMM:	DS	1	;305F
L3060:	DS	2	;3060
L3062:	DS	2	;3062
PARMQ:	DS	1	;3064
PARML:	DS	1	;3065
L3066:	DS	1	;3066
PARMR:	DS	1	;3067


ENDMAC	EQU	($ AND 0FF00H) + 100H
